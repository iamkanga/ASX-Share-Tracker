<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Share Tracker</title>
    <!-- Favicon: Eggplant emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÜ</text></svg>">

    <link rel="stylesheet" href="style.css?v=22"> <!-- Updated CSS version to v22 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-top-row">
            <h1 id="mainTitle">My ASX Share Watchlist</h1>
            <!-- Hamburger Menu Button for mobile -->
            <button id="hamburgerBtn" class="hamburger-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- Hamburger Menu Content (Initially hidden, shown on mobile) -->
        <nav id="mobileMenu" class="mobile-menu">
            <button id="closeMenuBtn" class="close-menu-btn">&times;</button>
            
            <!-- Moved Theme Toggle Button inside Hamburger Menu -->
            <div class="menu-section">
                <h3>Theme</h3>
                <div class="menu-buttons-group">
                    <button id="themeToggleBtn" class="menu-button-item"><i class="fas fa-moon"></i> Toggle Theme</button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Share Actions</h3>
                <div class="menu-buttons-group">
                    <button id="newShareBtn" class="menu-button-item"><i class="fas fa-plus-circle"></i> Add New Share</button>
                    <button id="viewDetailsBtn" class="menu-button-item" disabled><i class="fas fa-info-circle"></i> View Details</button>
                </div>
            </div>
            <div class="menu-section">
                <h3>Calculators</h3>
                <div class="menu-buttons-group">
                    <button id="standardCalcBtn" class="menu-button-item"><i class="fas fa-calculator"></i> Standard</button>
                    <button id="dividendCalcBtn" class="menu-button-item"><i class="fas fa-money-bill-wave"></i> Dividend</button>
                </div>
            </div>
        </nav>

        <!-- Watchlist and Sort controls -->
        <div class="watchlist-controls-row">
            <div class="watchlist-group">
                <!-- Removed label here. "Watchlist" will be the default selected option in the dropdown -->
                <select id="watchlistSelect" class="dropdown-large">
                    <!-- Options populated by JS, including 'Watchlist' placeholder -->
                </select>
                <!-- Removed manageWatchlistsBtn as per request -->
            </div>

            <div class="sort-group">
                <!-- Removed label here. "Sort" will be the default selected option in the dropdown -->
                <select id="sortSelect" class="dropdown-large">
                    <option value="" disabled selected>Sort</option> <!-- Explicit "Sort" placeholder -->
                    <option value="entryDate-desc">Date Added (Newest)</option>
                    <option value="entryDate-asc">Date Added (Oldest)</option>
                    <option value="shareName-asc">ASX Code (A-Z)</option>
                    <option value="shareName-desc">ASX Code (Z-A)</option>
                    <option value="lastFetchedPrice-desc">Current Price (High-Low)</option>
                    <option value="lastFetchedPrice-asc">Current Price (Low-High)</option>
                    <option value="dividendAmount-desc">Dividend (High-Low)</option>
                    <option value="dividendAmount-asc">Dividend (Low-High)</option>
                </select>
            </div>
        </div>
        
        <!-- ASX Code buttons container -->
        <div id="asxCodeButtonsContainer" class="asx-code-buttons-container">
            <!-- ASX code buttons will be dynamically added here -->
        </div>
    </header>

    <main class="container">
        <!-- Message for Firebase initialization errors -->
        <div id="firebaseInitError" class="error-message" style="display: none;">
            <p><strong>Error:</strong> Firebase failed to initialize.</p>
            <p>This is usually due to missing or incorrect Firebase configuration. Please ensure your <code>firebaseConfig</code> in <code>index.html</code> is correctly set up from your Firebase project settings.</p>
            <p>Core application features will not work without a valid Firebase connection.</p>
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">Loading shares...</div>
        <div class="share-list-section">
            <div class="table-container">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>ASX Code</th>
                            <th>Current Price</th>
                            <th>Target Price</th>
                            <th>Dividends</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be dynamically added here -->
            </div>
        </div>
    </main>

    <footer class="fixed-footer">
        <button id="googleAuthBtn" class="google-auth-btn">Sign In</button>
    </footer>

    <!-- Scroll-to-Top Button -->
    <button id="scrollToTopBtn" title="Go to top"><i class="fas fa-arrow-up"></i></button>

    <!-- Modals -->
    <!-- Share Form Modal -->
    <div id="shareFormSection" class="modal">
        <div class="modal-content add-share-modal-content">
            <span class="close-button form-close-button">&times;</span>
            <h2 id="formTitle">Add New Share</h2>
            <label for="shareName">ASX Code:</label>
            <input type="text" id="shareName" placeholder="e.g., BHP" required>

            <label for="currentPrice">Current Price ($):</label>
            <input type="number" id="currentPrice" step="0.01" placeholder="e.g., 25.50">

            <label for="targetPrice">Target Price ($):</label>
            <input type="number" id="targetPrice" step="0.01" placeholder="e.g., 30.00">

            <label for="dividendAmount">Dividend Amount (per share, annual $):</label>
            <input type="number" id="dividendAmount" step="0.001" placeholder="e.g., 1.250">

            <label for="frankingCredits">Franking Credits (%):</label>
            <input type="number" id="frankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70 for 70%">

            <div id="commentsFormContainer" class="comments-form-container">
                <h3>Comments <button type="button" id="addCommentSectionBtn" class="add-section-btn">+</button></h3>
                <!-- Comment sections will be dynamically added here by JS -->
            </div>

            <!-- Buttons for Add/Edit Share Modal - will be styled to be on one line -->
            <div class="form-action-buttons modal-form-buttons">
                <button type="button" id="deleteShareFromFormBtn" class="danger-button"><i class="fas fa-trash-alt"></i> Delete Share</button>
                <button type="button" id="cancelFormBtn" class="secondary-buttons"><i class="fas fa-times-circle"></i> Cancel</button>
                <button type="submit" id="saveShareBtn"><i class="fas fa-save"></i> Save Share</button>
            </div>
        </div>
    </div>

    <!-- Share Details Modal -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName">Share Details</h2>
            <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
            <p><strong>Current Price:</strong> <span id="modalCurrentPriceDetailed"></span></p>
            <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
            <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
            <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
            <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
            <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>

            <div id="modalCommentsContainer" class="modal-comments-sections">
                <h3>Comments</h3>
                <!-- Comments will be displayed here -->
            </div>

            <div class="modal-action-buttons">
                <button type="button" id="editShareFromDetailBtn"><i class="fas fa-edit"></i> Edit Share</button>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <span class="close-button calc-close-button">&times;</span>
            <h2>Dividend Calculator</h2>
            <div class="calc-input-group">
                <label for="calcDividendAmount">Annual Dividend Per Share ($):</label>
                <input type="number" id="calcDividendAmount" step="0.001" placeholder="e.g., 1.250">
            </div>
            <div class="calc-input-group">
                <label for="calcCurrentPrice">Current Share Price ($):</label>
                <input type="number" id="calcCurrentPrice" step="0.01" placeholder="e.g., 25.50">
            </div>
            <div class="calc-input-group">
                <label for="calcFrankingCredits">Franking Credits (%):</label>
                <input type="number" id="calcFrankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70">
            </div>
            <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">-</span></p>
            <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">-</span></p>
            <hr>
            <div class="calc-input-group">
                <label for="investmentValueSelect">Investment Value:</label>
                <select id="investmentValueSelect">
                    <option value="1000">$1,000</option>
                    <option value="5000">$5,000</option>
                    <option value="10000" selected>$10,000</option>
                    <option value="25000">$25,000</option>
                    <option value="50000">$50,000</option>
                    <option value="100000">$100,000</option>
                </select>
            </div>
            <p><strong>Estimated Annual Dividend:</strong> <span id="calcEstimatedDividend">-</span></p>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <span class="close-button">&times;</span>
            <h2>Standard Calculator</h2>
            <div class="calculator-display">
                <div id="calculatorInput" class="calculator-input"></div>
                <div id="calculatorResult" class="calculator-result">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="percentage">%</button>
                <button class="calc-btn operator" data-action="divide">√∑</button>
                <button class="calc-btn" data-value="7">7</button>
                <button class="calc-btn" data-value="8">8</button>
                <button class="calc-btn" data-value="9">9</button>
                <button class="calc-btn operator" data-action="multiply">√ó</button>
                <button class="calc-btn" data-value="4">4</button>
                <button class="calc-btn" data-value="5">5</button>
                <button class="calc-btn" data-value="6">6</button>
                <button class="calc-btn operator" data-action="subtract">-</button>
                <button class="calc-btn" data-value="1">1</button>
                <button class="calc-btn" data-value="2">2</button>
                <button class="calc-btn" data-value="3">3</button>
                <button class="calc-btn operator" data-action="add">+</button>
                <button class="calc-btn zero" data-value="0">0</button>
                <button class="calc-btn" data-value=".">.</button>
                <button class="calc-btn equals" data-action="calculate">=</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal for Alerts/Confirms -->
    <div id="customDialogModal" class="modal">
        <div class="modal-content">
            <p id="customDialogMessage"></p>
            <div class="custom-dialog-buttons">
                <button id="customDialogConfirmBtn" class="secondary-buttons">OK</button>
                <button id="customDialogCancelBtn" class="danger-button">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase and main script loading -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, FieldValue, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // YOUR FIREBASE CONFIGURATION - THIS HAS BEEN INSERTED BASED ON YOUR PROVIDED DETAILS
        const firebaseConfig = {
            apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw",
            authDomain: "asx-watchlist-app.firebaseapp.com",
            projectId: "asx-watchlist-app",
            storageBucket: "asx-watchlist-app.firebasestorage.app",
            messagingSenderId: "671024168765",
            appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54",
            measurementId: "G-J24BTJ34D2"
        };
        // END OF FIREBASE CONFIGURATION

        // Note: __app_id and __initial_auth_token are specific to the Canvas development environment.
        // For GitHub Pages, your Firebase project ID and app ID come directly from firebaseConfig above.
        const currentAppId = firebaseConfig.projectId || 'default-app-id'; // Use Firebase Project ID as app ID for hosted version

        // Initialize Firebase
        let firebaseApp;
        let auth;
        let db;
        let firebaseInitialized = false; // Flag to track successful initialization

        // Only initialize if config is valid (check for existence of apiKey and projectId)
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
            try {
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                firebaseInitialized = true;
                console.log("Firebase: Initialized successfully with config.");
            } catch (error) {
                console.error("Firebase: Failed to initialize app with provided config:", error);
                firebaseInitialized = false; // Ensure flag is false on error
            }
        } else {
            console.error("Firebase: Configuration is missing or invalid (apiKey or projectId). Firebase will not initialize.");
            const errorDiv = document.getElementById('firebaseInitError');
            if (errorDiv) {
                errorDiv.style.display = 'block'; // Make the error message visible
            }
            firebaseInitialized = false;
        }

        // Expose Firebase objects and auth functions globally for script.js
        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId; // Now uses the project ID from your firebaseConfig
        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete // Expose deleteField for migrations
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken, // Still included for compatibility, but might not be directly used for initial auth flow on GH Pages
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;


        // Authenticate when the DOM is fully loaded for the module script itself
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html (v25) script module loaded and DOMContentLoaded fired.");
            // We removed the custom event dispatch here, script.js will pick up firebaseAuth directly.
        }); 
    </script>
    <script src="script.js"></script>
</body>
</html>
```javascript
// File Version: v81
// Last Updated: 2025-06-26 (Hamburger menu, System Theme, Dropdown Logic, ASX Sort Fix, Scroll-to-Top)

// This script interacts with Firebase Firestore for data storage.
// Firebase app, db, auth instances, and userId are made globally available
// via window.firestoreDb, window.firebaseAuth, window.getFirebaseAppId(), etc.,
// from the <script type="module"> block in index.html.

document.addEventListener('DOMContentLoaded', function() {
    console.log("script.js (v81) DOMContentLoaded fired."); // New log to confirm script version and DOM ready

    // --- UI Element References ---
    // Moved ALL UI element declarations inside DOMContentLoaded for reliability
    const mainTitle = document.getElementById('mainTitle');
    
    // These buttons are now inside the hamburger menu for mobile, but referenced here for functionality
    const newShareBtn = document.getElementById('newShareBtn');
    const viewDetailsBtn = document.getElementById('viewDetailsBtn');
    const standardCalcBtn = document.getElementById('standardCalcBtn');
    const dividendCalcBtn = document.getElementById('dividendCalcBtn');

    const asxCodeButtonsContainer = document.getElementById('asxCodeButtonsContainer');

    const shareFormSection = document.getElementById('shareFormSection');
    const formCloseButton = document.querySelector('.form-close-button');
    const formTitle = document.getElementById('formTitle');
    const saveShareBtn = document.getElementById('saveShareBtn');
    const cancelFormBtn = document.getElementById('cancelFormBtn');
    const deleteShareFromFormBtn = document.getElementById('deleteShareFromFormBtn');

    const shareNameInput = document.getElementById('shareName');
    const currentPriceInput = document.getElementById('currentPrice'); // Manual current price input
    const targetPriceInput = document.getElementById('targetPrice');
    const dividendAmountInput = document.getElementById('dividendAmount');
    const frankingCreditsInput = document.getElementById('frankingCredits');
    const commentsFormContainer = document.getElementById('commentsFormContainer'); // Container for dynamic comment sections in form
    const addCommentSectionBtn = document.getElementById('addCommentSectionBtn'); // Button to add new comment sections

    const shareTableBody = document.querySelector('#shareTable tbody');
    const mobileShareCardsContainer = document.getElementById('mobileShareCards');

    const loadingIndicator = document.getElementById('loadingIndicator');

    // Consolidated auth button
    const googleAuthBtn = document.getElementById('googleAuthBtn');

    const shareDetailModal = document.getElementById('shareDetailModal');
    const modalShareName = document.getElementById('modalShareName');
    const modalEntryDate = document.getElementById('modalEntryDate');
    const modalCurrentPriceDetailed = document.getElementById('modalCurrentPriceDetailed'); // For detailed price display
    const modalTargetPrice = document.getElementById('modalTargetPrice');
    const modalDividendAmount = document.getElementById('modalDividendAmount');
    const modalFrankingCredits = document.getElementById('modalFrankingCredits');
    const modalCommentsContainer = document.getElementById('modalCommentsContainer'); // Container for structured comments display
    const modalUnfrankedYieldSpan = document.getElementById('modalUnfrankedYield');
    const modalFrankedYieldSpan = document.getElementById('modalFrankedYield');
    const editShareFromDetailBtn = document.getElementById('editShareFromDetailBtn'); // New button in detail modal

    const dividendCalculatorModal = document.getElementById('dividendCalculatorModal');
    const calcCloseButton = document.querySelector('.calc-close-button');
    const calcDividendAmountInput = document.getElementById('calcDividendAmount');
    const calcCurrentPriceInput = document.getElementById('calcCurrentPrice');
    const calcFrankingCreditsInput = document.getElementById('calcFrankingCredits');
    const calcUnfrankedYieldSpan = document.getElementById('calcUnfrankedYield');
    const calcFrankedYieldSpan = document.getElementById('calcFrankedYield');
    const investmentValueSelect = document.getElementById('investmentValueSelect'); // New dropdown for investment value
    const calcEstimatedDividend = document.getElementById('calcEstimatedDividend'); // New display for estimated dividend

    const sortSelect = document.getElementById('sortSelect'); // New sort dropdown

    // Custom Dialog Modal elements
    const customDialogModal = document.getElementById('customDialogModal');
    const customDialogMessage = document.getElementById('customDialogMessage');
    const customDialogConfirmBtn = document.getElementById('customDialogConfirmBtn');
    const customDialogCancelBtn = document.getElementById('customDialogCancelBtn');

    // Calculator elements
    const calculatorModal = document.getElementById('calculatorModal');
    const calculatorInput = document.getElementById('calculatorInput');
    const calculatorResult = document.getElementById('calculatorResult');
    const calculatorButtons = document.querySelector('.calculator-buttons');

    // Watchlist Management elements
    const watchlistSelect = document.getElementById('watchlistSelect');
    const manageWatchlistsBtn = document.getElementById('manageWatchlistsBtn'); // NEW: Manage Watchlists button

    // Theme Toggle Button
    const themeToggleBtn = document.getElementById('themeToggleBtn');

    // Scroll to Top Button
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');

    // Hamburger Menu elements
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const closeMenuBtn = document.getElementById('closeMenuBtn');
    const menuOverlay = document.createElement('div'); // Create overlay dynamically
    menuOverlay.classList.add('menu-overlay');
    document.body.appendChild(menuOverlay); // Append overlay to body


    // Array of all form input elements for easy iteration and form clearing (excluding dynamic comments)
    const formInputs = [
        shareNameInput, currentPriceInput, targetPriceInput,
        dividendAmountInput, frankingCreditsInput
    ];

    // --- State Variables ---
    let db;
    let auth = null; // Initialize auth to null
    let currentUserId = null;
    let currentAppId;
    let selectedShareDocId = null;
    let allSharesData = []; // Array to hold all loaded share data
    let currentDialogCallback = null; // Stores the function to call after custom dialog closes
    let autoDismissTimeout = null; // For auto-dismissing alerts

    // Double-tap/click variables
    let lastTapTime = 0;
    let tapTimeout;
    let selectedElementForTap = null; // Store the element that was tapped first
    
    // Mobile long press variables (for edit)
    let longPressTimer;
    const LONG_PRESS_THRESHOLD = 500; // Milliseconds for long press
    let touchStartX = 0;
    let touchStartY = 0;
    let touchMoved = false;
    const TOUCH_MOVE_THRESHOLD = 10; // Pixels to detect significant movement

    const KANGA_EMAIL = 'iamkanga@gmail.com'; // Specific email for title logic

    // Calculator state variables
    let currentCalculatorInput = ''; // Renamed to avoid conflict
    let operator = null;
    let previousCalculatorInput = ''; // Renamed to avoid conflict
    let resultDisplayed = false;

    // Watchlist state variables
    const DEFAULT_WATCHLIST_NAME = 'My Watchlist';
    const DEFAULT_WATCHLIST_ID_SUFFIX = 'default'; // A stable ID part for the default watchlist
    let userWatchlists = []; // Array of { id: ..., name: ... }
    let currentWatchlistId = null; // The ID of the currently active watchlist
    let currentWatchlistName = ''; // Stores the name of the currently active watchlist


    // --- Initial UI Setup (Now inside DOMContentLoaded) ---
    // Ensure all modals are hidden by default at page load using JavaScript and CSS !important rules.
    // Check if element exists before attempting to set style to prevent 'null' errors
    if (shareFormSection) shareFormSection.style.setProperty('display', 'none', 'important');
    if (dividendCalculatorModal) dividendCalculatorModal.style.setProperty('display', 'none', 'important');
    if (shareDetailModal) shareDetailModal.style.setProperty('display', 'none', 'important');
    if (customDialogModal) customDialogModal.style.setProperty('display', 'none', 'important'); // Ensure custom dialog is hidden
    if (calculatorModal) calculatorModal.style.setProperty('display', 'none', 'important'); // Ensure calculator modal is hidden

    updateMainButtonsState(false); // Initially disable buttons
    if (loadingIndicator) loadingIndicator.style.display = 'block';

    // Disable watchlist management elements initially
    if (watchlistSelect) watchlistSelect.disabled = true;
    if (manageWatchlistsBtn) manageWatchlistsBtn.disabled = true;
    
    // Disable Google Auth button initially until Firebase Auth is confirmed ready
    if (googleAuthBtn) googleAuthBtn.disabled = true;

    // Apply saved theme or default to system preference/light
    applySavedTheme();

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { // Use window.onload to ensure full page load for SW
            // Register service-worker.js relative to the current HTML file's directory.
            // This is crucial for GitHub Pages sub-repositories.
            // The scope parameter limits the service worker's control to this directory.
            navigator.serviceWorker.register('./service-worker.js', { scope: './' }) 
                .then(registration => {
                    console.log('Service Worker (v6): Registered with scope:', registration.scope); // This log is from the browser registering the service worker
                })
                .catch(error => {
                    console.error('Service Worker (v6): Registration failed:', error);
                });
        });
    }

    // --- Event Listeners for Input Fields ---
    if (shareNameInput) {
        shareNameInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }

    formInputs.forEach((input, index) => {
        if (input) {
            input.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    // If it's the last input, try to save or move to comments
                    if (index === formInputs.length - 1) {
                        const currentCommentInputs = commentsFormContainer.querySelector('.comment-title-input');
                        if (currentCommentInputs) {
                            currentCommentInputs.focus();
                        } else if (saveShareBtn) {
                            saveShareBtn.click();
                        }
                    } else {
                        // Otherwise, move to the next form input
                        if (formInputs[index + 1]) formInputs[index + 1].focus();
                    }
                }
            });
        }
    });

    // --- Centralized Modal Closing Function ---
    function closeModals() {
        document.querySelectorAll('.modal').forEach(modal => {
            if (modal) {
                // Use setProperty with !important to ensure override of CSS !important.
                modal.style.setProperty('display', 'none', 'important');
            }
        });
        // Reset calculator state when closing calculator modal
        resetCalculator();
        // Always deselect share when any modal is closed
        deselectCurrentShare(); 
        // Clear any pending auto-dismiss timeout if modal is closed manually
        if (autoDismissTimeout) {
            clearTimeout(autoDismissTimeout);
            autoDismissTimeout = null;
        }
    }

    // --- Event Listeners for Modal Close Buttons ---
    document.querySelectorAll('.close-button').forEach(button => {
        button.addEventListener('click', closeModals);
    });

    // --- Event Listener for Clicking Outside Modals ---
    window.addEventListener('click', (event) => {
        // Only close if the click is directly on the modal backdrop, not inside the modal-content
        if (event.target === shareDetailModal || event.target === dividendCalculatorModal || 
            event.target === shareFormSection || event.target === customDialogModal || 
            event.target === calculatorModal) {
            
            closeModals(); // Use the centralized closeModals
        }
    });

    // --- Firebase Initialization and Authentication State Listener ---
    // This logic relies on window.firebaseAuth being set by index.html module script
    db = window.firestoreDb;
    auth = window.firebaseAuth; // Assign auth here
    currentAppId = window.getFirebaseAppId();

    if (auth) { // Only proceed if auth object is successfully assigned
        // Enable the Google Auth button once auth is ready
        if (googleAuthBtn) {
            googleAuthBtn.disabled = false;
            console.log("[Auth] Google Auth button enabled."); // This log should now appear when auth is ready
        }
        
        // This listener ensures we react to authentication state changes (sign in/out)
        window.authFunctions.onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                updateAuthButtonText(true, user.email || user.displayName); // Pass user info to update button text
                console.log("[AuthState] User signed in:", user.uid);

                if (user.email && user.email.toLowerCase() === KANGA_EMAIL) {
                    mainTitle.textContent = "Kangas ASX Share Watchlist";
                } else {
                    mainTitle.textContent = "My ASX Share Watchlist";
                }
                
                updateMainButtonsState(true);
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                
                // Load watchlists first, then shares
                await loadUserWatchlists();
            } else {
                currentUserId = null;
                updateAuthButtonText(false); // No user info needed for sign out state
                mainTitle.textContent = "My ASX Share Watchlist";
                console.log("[AuthState] User signed out.");
                updateMainButtonsState(false);
                clearShareList();
                clearWatchlistUI(); // Clear watchlist UI too
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            }
        });
    } else {
        console.error("[Firebase] Firebase Auth not available. Cannot set up auth state listener or proceed with data loading.");
        // The index.html module script should now display a direct message if Firebase init fails
        updateAuthButtonText(false);
        updateMainButtonsState(false);
        if (loadingIndicator) loadingIndicator.style.display = 'none';
    }


    // --- Authentication Functions ---
    if (googleAuthBtn) {
        googleAuthBtn.addEventListener('click', async () => {
            console.log("[Auth] Google Auth Button Clicked."); // Debug: Confirm click
            // Always get the latest auth reference from window.firebaseAuth
            const currentAuth = window.firebaseAuth; 
            if (!currentAuth || !window.authFunctions) { 
                console.warn("[Auth] Auth service not ready or functions not loaded. Cannot process click. Is button still disabled?"); 
                showCustomAlert("Authentication service not ready. Please try again in a moment.");
                return;
            }

            if (currentAuth.currentUser) { // User is signed in, so this is a Sign Out action
                console.log("[Auth] Current user exists, attempting sign out."); // Debug: Sign out path
                try {
                    await window.authFunctions.signOut(currentAuth);
                    console.log("[Auth] User signed out.");
                } catch (error) {
                    console.error("[Auth] Sign-Out failed:", error);
                    showCustomAlert("Sign-Out failed: " + error.message);
                }
            } else { // User is not signed in, so this is a Sign In action
                console.log("[Auth] No current user, attempting sign in."); // Debug: Sign in path
                try {
                    const provider = window.authFunctions.GoogleAuthProviderInstance;
                    if (!provider) {
                        console.error("[Auth] GoogleAuthProvider instance not found. Is Firebase module script loaded?"); // Debug: Provider missing
                        showCustomAlert("Authentication service not ready. Please ensure Firebase module script is loaded."); // Changed alert message
                        return;
                    }
                    await window.authFunctions.signInWithPopup(currentAuth, provider);
                    console.log("[Auth] Google Sign-In successful.");
                }
                catch (error) {
                    console.error("[Auth] Google Sign-In failed:", error.message);
                    showCustomAlert("Google Sign-In failed: " + error.message);
                }
            }
        });
    }

    // --- UI State Management Functions ---
    function updateAuthButtonText(isSignedIn, userName = 'Sign In') {
        if (googleAuthBtn) {
            googleAuthBtn.textContent = isSignedIn ? (userName || 'Signed In') : 'Sign In'; // Changed default signed-in text to 'Signed In'
        }
    }

    function updateMainButtonsState(enable) {
        // These buttons are now primarily controlled by the hamburger menu,
        // but their disabled state should still reflect auth status.
        if (newShareBtn) newShareBtn.disabled = !enable;
        if (standardCalcBtn) standardCalcBtn.disabled = !enable;
        if (dividendCalcBtn) dividendCalcBtn.disabled = !enable;

        // Enable watchlist management elements based on auth state
        if (watchlistSelect) watchlistSelect.disabled = !enable;
        if (manageWatchlistsBtn) manageWatchlistsBtn.disabled = !enable;
        // viewDetailsBtn disabled state is managed by selectShare function
    }

    function showModal(modalElement) {
        if (modalElement) {
            // Use 'flex' to make it visible and center content,
            // overriding 'display: none !important;' from CSS.
            modalElement.style.setProperty('display', 'flex', 'important');
            modalElement.scrollTop = 0; // Scroll to top of modal content
        }
    }

    function hideModal(modalElement) {
        if (modalElement) {
            // Use 'none' to hide it. The !important in CSS will re-apply
            modalElement.style.setProperty('display', 'none', 'important');
        }
    }

    // --- Custom Dialog (Alert/Confirm) Functions ---
    // Updated to auto-dismiss
    function showCustomAlert(message, duration = 1000) { // Default duration 1 second (1000ms)
        // IMPORTANT: Ensure customDialogModal and its children exist before trying to use them
        if (!customDialogModal || !customDialogMessage || !customDialogConfirmBtn || !customDialogCancelBtn) {
            console.error("Custom dialog elements not found. Cannot show alert.");
            // Fallback to console log if elements are missing
            console.log("ALERT (fallback):", message);
            return;
        }
        customDialogMessage.textContent = message;
        // Hide buttons for auto-dismissing alerts
        customDialogConfirmBtn.style.display = 'none'; 
        customDialogCancelBtn.style.display = 'none';
        showModal(customDialogModal);

        // Clear any existing auto-dismiss timeout
        if (autoDismissTimeout) {
            clearTimeout(autoDismissTimeout);
        }

        // Set new auto-dismiss timeout
        autoDismissTimeout = setTimeout(() => {
            hideModal(customDialogModal);
            autoDismissTimeout = null; // Reset timeout variable
        }, duration);
    }

    // This function is still available but will not be used for deletion as per request.
    // It's here for potential future "important" confirmations if needed.
    function showCustomConfirm(message, onConfirm, onCancel = null) {
        // IMPORTANT: Ensure customDialogModal and its children exist before trying to use them
         if (!customDialogModal || !customDialogMessage || !customDialogConfirmBtn || !customDialogCancelBtn) {
            console.error("Custom dialog elements not found. Cannot show confirm.");
            // Fallback to console log if elements are missing
            const confirmed = window.confirm(message); // Fallback to native confirm
            if (confirmed && onConfirm) onConfirm();
            else if (!confirmed && onCancel) onCancel();
            return;
        }

        customDialogMessage.textContent = message;
        customDialogConfirmBtn.textContent = 'Yes';
        customDialogConfirmBtn.style.display = 'block';
        customDialogCancelBtn.textContent = 'No';
        customDialogCancelBtn.style.display = 'block'; // Show Cancel button
        showModal(customDialogModal);

        // Clear any existing auto-dismiss timeout if a confirmation is shown
        if (autoDismissTimeout) {
            clearTimeout(autoDismissTimeout);
        }

        customDialogConfirmBtn.onclick = () => {
            hideModal(customDialogModal);
            if (onConfirm) onConfirm();
            currentDialogCallback = null;
        };

        customDialogCancelBtn.onclick = () => {
            hideModal(customDialogModal);
            if (onCancel) onCancel();
            currentDialogCallback = null;
        };
        // Set currentDialogCallback to ensure consistent closing logic from outside clicks
        currentDialogCallback = () => {
            hideModal(customDialogModal);
            if (onCancel) onCancel(); // Treat outside click as a "No"
            currentDialogCallback = null;
        };
    }


    // --- Date Formatting Helper Functions (Australian Style) ---
    function formatDate(dateString) {
        if (!dateString) return ''; // Return empty string for missing date
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return ''; // Check for invalid date
        return date.toLocaleDateString('en-AU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function formatDateTime(dateString) {
        if (!dateString) return ''; // Return empty string for missing date
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return ''; // Check for invalid date
        return date.toLocaleDateString('en-AU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false // 24-hour format
        });
    }

    // --- Watchlist Management Functions ---

    // Function to generate a consistent default watchlist ID
    function getDefaultWatchlistId(userId) {
        return `${userId}_${DEFAULT_WATCHLIST_ID_SUFFIX}`;
    }

    // Load watchlists from Firestore and set the current one
    async function loadUserWatchlists() {
        if (!db || !currentUserId) {
            console.warn("[Watchlist] Firestore DB or User ID not available for loading watchlists.");
            return;
        }

        userWatchlists = []; // Clear existing watchlists
        // Safely access window.firestore.collection
        const watchlistsColRef = window.firestore ? window.firestore.collection(db, `artifacts/${currentAppId}/users/${currentUserId}/watchlists`) : null;
        const userProfileDocRef = window.firestore ? window.firestore.doc(db, `artifacts/${currentAppId}/users/${currentUserId}/profile/settings`) : null; // User profile for last selected watchlist

        if (!watchlistsColRef || !userProfileDocRef) {
            console.error("[Watchlist] Firestore collection or doc reference is null. Cannot load watchlists.");
            showCustomAlert("Firestore services not fully initialized. Cannot load watchlists.");
            return;
        }

        try {
            console.log("[Watchlist] Fetching user watchlists...");
            const querySnapshot = await window.firestore.getDocs(watchlistsColRef);
            querySnapshot.forEach(doc => {
                userWatchlists.push({ id: doc.id, name: doc.data().name });
            });
            console.log(`[Watchlist] Found ${userWatchlists.length} existing watchlists.`);

            // If no watchlists exist, create a default one
            if (userWatchlists.length === 0) {
                const defaultWatchlistRef = window.firestore.doc(db, `artifacts/${currentAppId}/users/${currentUserId}/watchlists/${getDefaultWatchlistId(currentUserId)}`);
                await window.firestore.setDoc(defaultWatchlistRef, { name: DEFAULT_WATCHLIST_NAME, createdAt: new Date().toISOString() });
                userWatchlists.push({ id: getDefaultWatchlistId(currentUserId), name: DEFAULT_WATCHLIST_NAME });
                console.log("[Watchlist] Created default watchlist.");
            }

            // Sort watchlists alphabetically by name
            userWatchlists.sort((a, b) => a.name.localeCompare(b.name));

            // Load last selected watchlist from user profile
            const userProfileSnap = await window.firestore.getDoc(userProfileDocRef);
            let lastSelectedWatchlistId = null;
            if (userProfileSnap.exists()) {
                lastSelectedWatchlistId = userProfileSnap.data().lastSelectedWatchlistId;
                console.log(`[Watchlist] Found last selected watchlist in profile: ${lastSelectedWatchlistId}`);
            }

            // Prioritize last selected, then default, then first available
            let targetWatchlist = null;
            if (lastSelectedWatchlistId) {
                targetWatchlist = userWatchlists.find(w => w.id === lastSelectedWatchlistId);
            }
            if (!targetWatchlist) { // If last selected not found or not set, try default
                targetWatchlist = userWatchlists.find(w => w.name === DEFAULT_WATCHLIST_NAME);
            }
            if (!targetWatchlist && userWatchlists.length > 0) { // Fallback to first if neither found
                targetWatchlist = userWatchlists[0];
            }

            if (targetWatchlist) {
                currentWatchlistId = targetWatchlist.id;
                currentWatchlistName = targetWatchlist.name;
                console.log(`[Watchlist] Setting current watchlist to: '${currentWatchlistName}' (ID: ${currentWatchlistId})`);
            } else {
                currentWatchlistId = null;
                currentWatchlistName = 'No Watchlist Selected';
                console.log("[Watchlist] No watchlists available. Current watchlist set to null.");
            }

            renderWatchlistSelect(); // Populate the dropdown and set its selected value
            renderSortSelect(); // Also ensure sort select is rendered/updated
            updateMainButtonsState(true); // Re-enable buttons

            const migratedSomething = await migrateOldSharesToWatchlist();
            if (!migratedSomething) {
                console.log("[Watchlist] No old shares to migrate/update, directly loading shares for current watchlist.");
                await loadShares(); // Load shares for the (already determined) currentWatchlistId
            }

        } catch (error) {
            console.error("[Watchlist] Error loading user watchlists:", error);
            showCustomAlert("Error loading watchlists: " + error.message);
        } finally {
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
    }

    // Function to render options in the watchlist dropdown
    function renderWatchlistSelect() {
        if (!watchlistSelect) return;
        watchlistSelect.innerHTML = ''; // Clear existing options

        // Add a placeholder option for all views
        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = 'Watchlist'; // Text for the placeholder
        placeholderOption.disabled = true;
        placeholderOption.selected = true; // Make it selected by default
        watchlistSelect.appendChild(placeholderOption);

        if (userWatchlists.length === 0) {
            // If no watchlists, ensure the placeholder is the only option and dropdown is disabled
            watchlistSelect.disabled = true;
            manageWatchlistsBtn.disabled = true;
            return;
        }

        userWatchlists.forEach(watchlist => {
            const option = document.createElement('option');
            option.value = watchlist.id;
            option.textContent = watchlist.name;
            watchlistSelect.appendChild(option);
        });

        // Set the selected option based on currentWatchlistId, if a valid one exists
        if (currentWatchlistId && userWatchlists.some(w => w.id === currentWatchlistId)) {
            watchlistSelect.value = currentWatchlistId;
            console.log(`[UI Update] Watchlist dropdown set to: ${currentWatchlistName} (ID: ${currentWatchlistId})`);
        } else if (userWatchlists.length > 0) {
            // Fallback: If currentWatchlistId is somehow null or invalid, select the first actual watchlist
            watchlistSelect.value = userWatchlists[0].id;
            currentWatchlistId = userWatchlists[0].id; // Re-sync currentWatchlistId
            currentWatchlistName = userWatchlists[0].name; // Re-sync currentWatchlistName
            console.warn(`[UI Update] currentWatchlistId was null/invalid, fallback to first watchlist: ${currentWatchlistName} (ID: ${currentWatchlistId})`);
        } else {
             // If no user watchlists exist, ensure placeholder remains selected
             watchlistSelect.value = '';
        }

        watchlistSelect.disabled = false;
        manageWatchlistsBtn.disabled = false; // Enable manage button if watchlists exist
    }

    // Function to render options in the sort by dropdown
    function renderSortSelect() {
        if (!sortSelect) return;

        // Ensure the "Sort By" placeholder is the first option, if not already.
        // The HTML already has this, but we ensure its `value` is empty and it's selected.
        const firstOption = sortSelect.options[0];
        if (firstOption && firstOption.value === '') {
            firstOption.textContent = 'Sort'; // Ensure text is 'Sort'
            firstOption.disabled = true;
            firstOption.selected = true;
        } else {
            // If somehow missing, add it
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = 'Sort';
            placeholderOption.disabled = true;
            placeholderOption.selected = true;
            sortSelect.insertBefore(placeholderOption, sortSelect.firstChild);
        }
        
        // Ensure "Sort" is selected if no specific sort is applied (e.g., on first load)
        if (!sortSelect.value || sortSelect.value === '') {
            sortSelect.value = '';
        }
    }


    // Event listener for watchlist selection change
    if (watchlistSelect) {
        watchlistSelect.addEventListener('change', async () => {
            currentWatchlistId = watchlistSelect.value;
            const selectedWatchlistObj = userWatchlists.find(w => w.id === currentWatchlistId);
            if (selectedWatchlistObj) {
                currentWatchlistName = selectedWatchlistObj.name;
                console.log(`[Watchlist Change] User selected: '${currentWatchlistName}' (ID: ${currentWatchlistId})`);
                await saveLastSelectedWatchlistId(currentWatchlistId); // Save new selection
                await loadShares(); // Reload shares for the newly selected watchlist
            }
        });
    }

    // Save the last selected watchlist ID to user's profile
    async function saveLastSelectedWatchlistId(watchlistId) {
        if (!db || !currentUserId || !window.firestore) {
            console.warn("[Watchlist] Cannot save last selected watchlist: DB, User ID, or Firestore functions not available.");
            return;
        }
        const userProfileDocRef = window.firestore.doc(db, `artifacts/${currentAppId}/users/${currentUserId}/profile/settings`);
        try {
            await window.firestore.setDoc(userProfileDocRef, { lastSelectedWatchlistId: watchlistId }, { merge: true });
            console.log(`[Watchlist] Saved last selected watchlist ID: ${watchlistId}`);
        } catch (error) {
            console.error("[Watchlist] Error saving last selected watchlist ID:", error);
        }
    }

    // NEW: Manage Watchlists button handler
    if (manageWatchlistsBtn) {
        manageWatchlistsBtn.addEventListener('click', () => {
            if (!currentUserId || !window.firestore) {
                showCustomAlert("Please sign in to manage watchlists.");
                return;
            }
            // For now, this just shows an alert. This will be replaced with a proper modal later.
            showCustomAlert("Manage Watchlists functionality coming soon!");
            console.log("[Watchlist] Manage Watchlists button clicked.");
        });
    }


    // --- Share Data Management Functions ---
    async function loadShares() {
        if (!db || !currentUserId || !currentWatchlistId || !window.firestore) {
            console.warn("[Shares] Firestore DB, User ID, Watchlist ID, or Firestore functions not available for loading shares. Clearing list.");
            clearShareList();
            return;
        }

        if (loadingIndicator) loadingIndicator.style.display = 'block';
        allSharesData = []; // Clear previous data from the array

        try {
            const sharesCol = window.firestore.collection(db, `artifacts/${currentAppId}/users/${currentUserId}/shares`);
            const q = window.firestore.query(
                sharesCol,
                window.firestore.where("watchlistId", "==", currentWatchlistId) 
            );
            console.log(`[Shares] Attempting to load shares for watchlist ID: ${currentWatchlistId} (Name: ${currentWatchlistName})`);
            const querySnapshot = await window.firestore.getDocs(q);

            querySnapshot.forEach((doc) => {
                const share = { id: doc.id, ...doc.data() };
                allSharesData.push(share);
            });
            console.log(`[Shares] Shares loaded successfully for watchlist: '${currentWatchlistName}' (ID: ${currentWatchlistId}). Total shares: ${allSharesData.length}`);
            console.log("[Shares] All shares data (after load):", allSharesData);


            sortShares(); // This will also call renderWatchlist()
            renderAsxCodeButtons(); // Render ASX Code buttons
        } catch (error) {
            console.error("[Shares] Error loading shares:", error);
            showCustomAlert("Error loading shares: " + error.message);
        } finally {
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
    }

    // One-time migration function for old shares without a watchlistId AND old shareName field
    // Also converts string-numbers to actual numbers and standardizes franking credits.
    // Returns true if any updates/migrations occurred, false otherwise.
    async function migrateOldSharesToWatchlist() {
        if (!db || !currentUserId || !window.firestore) {
            console.warn("[Migration] Firestore DB, User ID, or Firestore functions not available for migration.");
            return false;
        }

        const sharesCol = window.firestore.collection(db, `artifacts/${currentAppId}/users/${currentUserId}/shares`);
        const q = window.firestore.query(sharesCol);

        let sharesToUpdate = [];
        let anyMigrationPerformed = false;

        try {
            console.log("[Migration] Checking for old shares to migrate/update schema and data types...");
            const querySnapshot = await window.firestore.getDocs(q);

            querySnapshot.forEach(doc => {
                const shareData = doc.data();
                let updatePayload = {};
                let needsUpdate = false;

                // 1. Check for missing watchlistId
                if (!shareData.hasOwnProperty('watchlistId')) {
                    needsUpdate = true;
                    updatePayload.watchlistId = getDefaultWatchlistId(currentUserId);
                    console.log(`[Migration] Share '${doc.id}' missing watchlistId. Assigning to default.`);
                }

                // 2. Check for missing shareName but existing 'name' field
                if ((!shareData.shareName || String(shareData.shareName).trim() === '') && shareData.hasOwnProperty('name') && String(shareData.name).trim() !== '') {
                    needsUpdate = true;
                    updatePayload.shareName = String(shareData.name).trim(); // Copy 'name' to 'shareName'
                    updatePayload.name = window.firestore.deleteField(); // Delete old 'name' field
                    console.log(`[Migration] Share '${doc.id}' missing 'shareName' but has 'name' ('${shareData.name}'). Migrating 'name' to 'shareName'.`);
                }

                // 3. Convert string numbers to actual numbers for critical fields
                const fieldsToConvert = ['currentPrice', 'targetPrice', 'dividendAmount', 'frankingCredits', 'entryPrice', 'lastFetchedPrice', 'previousFetchedPrice']; // Added all relevant numerical fields
                fieldsToConvert.forEach(field => {
                    const value = shareData[field];
                    const originalValueType = typeof value;
                    let parsedValue = value; // Default to original value

                    if (originalValueType === 'string' && value.trim() !== '') {
                        parsedValue = parseFloat(value);
                        if (!isNaN(parsedValue)) {
                            // Only update if the type changes or is a meaningful conversion
                            if (originalValueType !== typeof parsedValue || value !== String(parsedValue)) {
                                needsUpdate = true;
                                updatePayload[field] = parsedValue;
                                console.log(`[Migration] Share '${doc.id}': Converted ${field} from string '${value}' (type ${originalValueType}) to number ${parsedValue}.`);
                            }
                        } else {
                            // If it's a string but not a valid number, set to null
                            needsUpdate = true;
                            updatePayload[field] = null;
                            console.warn(`[Migration] Share '${doc.id}': Field '${field}' was invalid string '${value}', setting to null.`);
                        }
                    } else if (originalValueType === 'number' && isNaN(value)) { // Handle existing NaNs
                        needsUpdate = true;
                        updatePayload[field] = null;
                        console.warn(`[Migration] Share '${doc.id}': Field '${field}' was NaN number, setting to null.`);
                    }

                    // Special handling for frankingCredits: convert 0.x to X%
                    if (field === 'frankingCredits' && typeof parsedValue === 'number' && !isNaN(parsedValue)) {
                        if (parsedValue > 0 && parsedValue < 1) { // e.g., 0.6 instead of 60
                            needsUpdate = true;
                            updatePayload.frankingCredits = parsedValue * 100;
                            console.log(`[Migration] Share '${doc.id}': Converted frankingCredits from decimal ${parsedValue} to percentage ${parsedValue * 100}.`);
                        }
                    }
                });

                // 4. Ensure `lastFetchedPrice`, `previousFetchedPrice`, `lastPriceUpdateTime` are set
                // Use `entryPrice` if `currentPrice` is missing, otherwise default to `null`
                const effectiveCurrentPrice = (typeof updatePayload.currentPrice === 'number' && !isNaN(updatePayload.currentPrice)) ? updatePayload.currentPrice : 
                                              ((typeof shareData.currentPrice === 'string' ? parseFloat(shareData.currentPrice) : shareData.currentPrice) || null);
                
                if (!shareData.hasOwnProperty('lastFetchedPrice') || (typeof shareData.lastFetchedPrice === 'string' && isNaN(parseFloat(shareData.lastFetchedPrice)))) {
                    needsUpdate = true;
                    updatePayload.lastFetchedPrice = effectiveCurrentPrice;
                    console.log(`[Migration] Share '${doc.id}': Setting missing lastFetchedPrice to ${effectiveCurrentPrice}.`);
                }
                if (!shareData.hasOwnProperty('previousFetchedPrice') || (typeof shareData.previousFetchedPrice === 'string' && isNaN(parseFloat(shareData.previousFetchedPrice)))) {
                    needsUpdate = true;
                    updatePayload.previousFetchedPrice = effectiveCurrentPrice;
                    console.log(`[Migration] Share '${doc.id}': Setting missing previousFetchedPrice to ${effectiveCurrentPrice}.`);
                }
                if (!shareData.hasOwnProperty('lastPriceUpdateTime')) {
                    needsUpdate = true;
                    updatePayload.lastPriceUpdateTime = new Date().toISOString();
                    console.log(`[Migration] Share '${doc.id}': Setting missing lastPriceUpdateTime.`);
                }

                // 5. If comments exists as a string, attempt to parse it (from very old versions)
                if (typeof shareData.comments === 'string' && shareData.comments.trim() !== '') {
                    try {
                        const parsedComments = JSON.parse(shareData.comments);
                        if (Array.isArray(parsedComments)) {
                            needsUpdate = true;
                            updatePayload.comments = parsedComments;
                            console.log(`[Migration] Share '${doc.id}': Converted comments string to array.`);
                        }
                    } catch (e) {
                        // If parsing fails, wrap the single string as a comment
                        needsUpdate = true;
                        updatePayload.comments = [{ title: "General Comments", text: shareData.comments }];
                        console.log(`[Migration] Share '${doc.id}': Wrapped comments string as single comment object.`);
                    }
                }

                if (needsUpdate) {
                    sharesToUpdate.push({ ref: doc.ref, data: updatePayload });
                }
            });

            if (sharesToUpdate.length > 0) {
                console.log(`[Migration] Performing consolidated update for ${sharesToUpdate.length} shares.`);
                for (const item of sharesToUpdate) {
                    await window.firestore.updateDoc(item.ref, item.data);
                }
                showCustomAlert(`Migrated/Updated ${sharesToUpdate.length} old shares.`, 2000);
                console.log("[Migration] Migration complete. Reloading shares.");
                await loadShares(); // Reload shares *after* migration
                anyMigrationPerformed = true;
            } else {
                console.log("[Migration] No old shares found requiring migration or schema update.");
            }
            return anyMigrationPerformed;

        } catch (error) {
            console.error("[Migration] Error during migration/schema update:", error);
            showCustomAlert("Error during data migration: " + error.message);
            return false;
        }
    }

    // NEW FUNCTION: renderAsxCodeButtons
    // This function generates and displays buttons for each unique ASX code in the current watchlist.
    function renderAsxCodeButtons() {
        if (!asxCodeButtonsContainer) return;

        asxCodeButtonsContainer.innerHTML = ''; // Clear existing buttons
        const uniqueAsxCodes = new Set();

        // Filter `allSharesData` based on `currentWatchlistId` before processing
        const sharesInCurrentWatchlist = allSharesData.filter(share => share.watchlistId === currentWatchlistId);

        sharesInCurrentWatchlist.forEach(share => {
            if (share.shareName && typeof share.shareName === 'string' && share.shareName.trim() !== '') {
                uniqueAsxCodes.add(share.shareName.trim().toUpperCase());
            }
        });

        if (uniqueAsxCodes.size === 0) {
            asxCodeButtonsContainer.style.display = 'none'; // Hide container if no codes
            return;
        } else {
            asxCodeButtonsContainer.style.display = 'flex'; // Show container if there are codes
        }

        // Convert Set to Array and sort alphabetically
        const sortedAsxCodes = Array.from(uniqueAsxCodes).sort();

        sortedAsxCodes.forEach(asxCode => {
            const button = document.createElement('button');
            button.className = 'asx-code-button';
            button.textContent = asxCode;
            button.dataset.asxCode = asxCode; // Store the code for easy access
            asxCodeButtonsContainer.appendChild(button);

            button.addEventListener('click', (event) => {
                const clickedCode = event.target.dataset.asxCode;
                // Scroll to the share in the table/cards, or highlight it
                scrollToShare(clickedCode);
            });
        });
        console.log(`[UI] Rendered ${sortedAsxCodes.length} ASX code buttons.`);
    }

    // NEW FUNCTION: scrollToShare
    function scrollToShare(asxCode) {
        console.log(`[UI] Attempting to scroll to/highlight share with ASX Code: ${asxCode}`);
        const targetShare = allSharesData.find(s => s.shareName && s.shareName.toUpperCase() === asxCode.toUpperCase());
        if (targetShare) {
            selectShare(targetShare.id); // Select and highlight the share
            
            // Attempt to scroll to the element. Prefer desktop table if visible, else mobile card.
            let elementToScrollTo = document.querySelector(`#shareTable tbody tr[data-doc-id="${targetShare.id}"]`);
            if (!elementToScrollTo && window.matchMedia("(max-width: 767px)").matches) { // Corrected breakpoint
                elementToScrollTo = document.querySelector(`.mobile-card[data-doc-id="${targetShare.id}"]`);
            }

            if (elementToScrollTo) {
                elementToScrollTo.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            showShareDetails(); // Open the details modal after selecting
        } else {
            showCustomAlert(`Share '${asxCode}' not found.`);
        }
    }


    // Function to re-render the watchlist (table and cards) after sorting or other changes
    function renderWatchlist() {
        console.log(`[Render] Rendering watchlist for currentWatchlistId: ${currentWatchlistId} (Name: ${currentWatchlistName})`);
        clearShareListUI();
        // Filter `allSharesData` based on `currentWatchlistId` before rendering
        const sharesToRender = allSharesData.filter(share => share.watchlistId === currentWatchlistId);
        console.log(`[Render] Shares filtered for rendering. Total shares to render: ${sharesToRender.length}`);
        console.log("[Render] Shares to render details:", sharesToRender); // This is the debug log showing share objects

        sharesToRender.forEach((share) => {
            // FIX: Ensure these functions are called
            addShareToTable(share);
            if (window.matchMedia("(max-width: 767px)").matches) { // Corrected breakpoint to match CSS
                 addShareToMobileCards(share);
            }
        });
        
        // After re-rendering, if a share was previously selected, re-select it
        if (selectedShareDocId) {
             const stillExists = sharesToRender.some(share => share.id === selectedShareDocId);
             if (stillExists) {
                selectShare(selectedShareDocId);
             } else {
                deselectCurrentShare(); // If selected share no longer exists (e.g. deleted), deselect
             }
        } else {
            if (viewDetailsBtn) viewDetailsBtn.disabled = true; // No share selected, keep button disabled
        }
    }

    function clearShareListUI() {
        if (shareTableBody) shareTableBody.innerHTML = '';
        if (mobileShareCardsContainer) mobileShareCardsContainer.innerHTML = '';
        console.log("[UI] Share list UI cleared.");
    }

    function clearShareList() {
        clearShareListUI();
        if (asxCodeButtonsContainer) asxCodeButtonsContainer.innerHTML = ''; // Clear ASX code buttons
        deselectCurrentShare(); // Ensure selection is cleared explicitly here
        console.log("[UI] Full share list cleared (UI + buttons).");
    }

    // New function to clear watchlist specific UI elements
    function clearWatchlistUI() {
        if (watchlistSelect) watchlistSelect.innerHTML = '';
        userWatchlists = []; // Clear the internal array
        if (watchlistSelect) watchlistSelect.disabled = true;
        if (manageWatchlistsBtn) manageWatchlistsBtn.disabled = true;
        renderWatchlistSelect(); // Re-render to show placeholder for empty state
        renderSortSelect(); // Ensure sort select is also updated
        console.log("[UI] Watchlist UI cleared.");
    }

    // Function to truncate text
    function truncateText(text, maxLength) {
        if (typeof text !== 'string' || text.length <= maxLength) {
            return text;
        }
        return text.substring(0, maxLength) + '...';
    }

    // Function to deselect currently highlighted share
    function deselectCurrentShare() {
        const currentlySelected = document.querySelectorAll('.share-list-section tr.selected, .mobile-card.selected'); // Changed class name
        console.log(`[Selection] Attempting to deselect ${currentlySelected.length} elements.`);
        
        currentlySelected.forEach(el => {
            console.log(`[Selection] Before removal - Element with docId: ${el.dataset.docId}, ClassList: ${el.classList.toString()}`);
            el.classList.remove('selected');
            console.log(`[Selection] After removal - Element with docId: ${el.dataset.docId}, ClassList: ${el.classList.toString()}`);
        });
        selectedShareDocId = null;
        if (viewDetailsBtn) {
            viewDetailsBtn.disabled = true; // Always disable view button when nothing is selected
        }
        console.log("[Selection] Share deselected. selectedShareDocId is now null.");
    }

    // --- Watchlist Sorting Logic ---
    function sortShares() {
        const sortValue = sortSelect.value;
        // If the placeholder is selected, default to a sorting or do nothing.
        if (!sortValue || sortValue === '') {
            console.log("[Sort] Sort placeholder selected, no explicit sorting applied.");
            renderWatchlist(); // Just re-render without explicit sorting, maintaining current order
            return;
        }

        const [field, order] = sortValue.split('-');

        allSharesData.sort((a, b) => {
            let valA = a[field];
            let valB = b[field];

            // Debugging log for sorting:
            console.log(`[Sort Debug] Field: ${field}, Order: ${order}`);
            console.log(`[Sort Debug] Comparing A: ${JSON.stringify(a.shareName || '(empty)')}, B: ${JSON.stringify(b.shareName || '(empty)')}`);


            // Handle nulls/undefined/non-numbers for numerical fields for robust sorting
            // Ensure values are parsed to numbers for comparison
            if (field === 'lastFetchedPrice' || field === 'dividendAmount' || field === 'currentPrice' || field === 'targetPrice' || field === 'frankingCredits') {
                valA = (typeof valA === 'string' && valA.trim() !== '') ? parseFloat(valA) : valA;
                valB = (typeof valB === 'string' && valB.trim() !== '') ? parseFloat(valB) : valB;

                valA = (valA === null || valA === undefined || isNaN(valA)) ? (order === 'asc' ? Infinity : -Infinity) : valA;
                valB = (valB === null || valB === undefined || isNaN(valB)) ? (order === 'asc' ? Infinity : -Infinity) : valB;

                console.log(`[Sort Debug] Numeric comparison - Processed A: ${valA}, Processed B: ${valB}`);
                return order === 'asc' ? valA - valB : valB - valA;

            } else if (field === 'shareName') { // String comparison, specifically for ASX Code
                const nameA = (a.shareName || '').toUpperCase().trim(); // Ensure string, uppercase, no leading/trailing spaces
                const nameB = (b.shareName || '').toUpperCase().trim(); // Ensure string, uppercase, no leading/trailing spaces
