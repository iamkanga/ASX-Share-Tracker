<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Tracker</title> <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÜ</text></svg>">

    <link rel="stylesheet" href="style.css?v=47"> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-top-row">
            <button id="hamburgerBtn" class="header-action-btn header-action-btn-left">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="mainTitle">Share Watchlist</h1> <button id="addShareHeaderBtn" class="header-action-btn header-action-btn-right">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div id="watchlistControls" class="watchlist-controls hidden">
            <div class="watchlist-group">
                <button id="allSharesBtn" class="watchlist-filter-btn active">All Shares</button>
                <button id="favouriteSharesBtn" class="watchlist-filter-btn">Favourites</button>
                <button id="positiveSharesBtn" class="watchlist-filter-btn">Positive</button>
                <button id="negativeSharesBtn" class="watchlist-filter-btn">Negative</button>
                <button id="neutralSharesBtn" class="watchlist-filter-btn">Neutral</button>
            </div>
            <div class="sort-group">
                <select id="sortOrderDropdown" class="dropdown">
                    <option value="none">Sort By</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="gain-desc">Gain (%) (High to Low)</option>
                    <option value="gain-asc">Gain (%) (Low to High)</option>
                    <option value="current-price-desc">Current Price (High to Low)</option>
                    <option value="current-price-asc">Current Price (Low to High)</option>
                    <option value="asx-code-asc">ASX Code (A-Z)</option>
                    <option value="asx-code-desc">ASX Code (Z-A)</option>
                </select>
                <select id="groupingDropdown" class="dropdown-large">
                    <option value="none">Group By</option>
                    <option value="gain-status">Gain Status (Pos/Neg/Neu)</option>
                    <option value="exchange">Exchange</option>
                    <option value="favourite">Favourite</option>
                </select>
            </div>
        </div>
    </header>

    <main>
        <div id="loadingSpinner" class="spinner-container">
            <div class="spinner"></div>
            <p>Loading shares...</p>
        </div>

        <section id="authSection" class="auth-section">
            <p>Please sign in to manage your share watchlist.</p>
            <button id="googleAuthBtn" class="google-auth-btn">
                <i class="fab fa-google"></i> Sign In with Google
            </button>
            <p id="authError" class="error-message"></p>
        </section>

        <section id="shareListSection" class="share-list-section hidden">
            <div class="table-container">
                <table id="shareTable" class="share-table">
                    <thead>
                        <tr>
                            <th></th> <th>ASX Code</th>
                            <th>Company Name</th>
                            <th>Entered Price</th>
                            <th>Current Price</th>
                            <th>Gain/Loss (%)</th>
                            <th>Dividend Yield (%)</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="shareTableBody">
                        </tbody>
                </table>
            </div>

            <div id="mobileShareCards" class="mobile-share-cards">
                </div>

            <p id="noSharesMessage" class="hidden">No shares added yet. Click '+' to add one!</p>
            <button id="addShareMainBtn" class="add-share-btn">
                <i class="fas fa-plus"></i> Add Share
            </button>
        </section>

        <button id="scrollToTopBtn" class="scroll-to-top-btn"><i class="fas fa-arrow-up"></i></button>
    </main>

    <aside id="appSidebar" class="app-sidebar">
        <div class="sidebar-header">
            <span id="sidebarUserName">Guest</span>
            <span id="sidebarUserEmail" class="small-text"></span>
            <button id="closeSidebarBtn" class="close-sidebar-btn"><i class="fas fa-times"></i></button>
        </div>
        <nav>
            <ul class="sidebar-menu">
                <li><button id="addShareSidebarBtn" class="menu-button-item" data-action-closes-menu="true">Add New Share</button></li>
                <li><button id="calculatorSidebarBtn" class="menu-button-item" data-action-closes-menu="true">Calculator</button></li>
                <li><button id="themeToggleBtn" class="menu-button-item">Theme</button></li>
                <li><button id="signOutBtn" class="menu-button-item">Sign Out</button></li>
                <li><button id="deleteAccountBtn" class="menu-button-item delete-btn">Delete Account</button></li>
            </ul>
        </nav>
    </aside>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <div id="shareFormModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="shareFormModal">&times;</span>
            <h2 id="shareFormTitle">Add New Share</h2>
            <form id="shareForm">
                <label for="asxCode">ASX Code:</label>
                <input type="text" id="asxCode" required placeholder="e.g., CBA, BHP">

                <label for="companyName">Company Name:</label>
                <input type="text" id="companyName" required placeholder="e.g., Commonwealth Bank">

                <label for="enteredPrice">Entered Price:</label>
                <input type="number" id="enteredPrice" step="0.01" required placeholder="e.g., 95.50">

                <label for="currentPrice">Current Price:</label>
                <input type="number" id="currentPrice" step="0.01" required placeholder="e.g., 98.75">

                <label for="dividendYield">Dividend Yield (%):</label>
                <input type="number" id="dividendYield" step="0.01" placeholder="e.g., 3.5">

                <div class="form-group-checkbox">
                    <input type="checkbox" id="isFavourite">
                    <label for="isFavourite">Favourite</label>
                </div>

                <div id="commentsFormContainer">
                    <div class="comment-section">
                        <label for="commentTitle1">Comment Title:</label>
                        <input type="text" id="commentTitle1" class="comment-title" placeholder="e.g., Investment Thesis">
                        <label for="commentText1">Comment:</label>
                        <textarea id="commentText1" class="comment-text" rows="3" placeholder="e.g., Strong fundamentals, long-term hold."></textarea>
                    </div>
                </div>
                <button type="button" id="addCommentBtn" class="secondary-button add-comment-btn"><i class="fas fa-plus"></i> Add Comment Section</button>

                <button type="submit" id="saveShareBtn">Save Share</button>
                <button type="button" id="deleteShareFormBtn" class="delete-btn hidden">Delete Share</button>
            </form>
        </div>
    </div>

    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="shareDetailModal">&times;</span>
            <h2 id="modalShareName"></h2>
            <p><strong>ASX Code:</strong> <span id="modalAsxCode"></span></p>
            <p><strong>Entered Price:</strong> <span id="modalEnteredPrice"></span></p>
            <p><strong>Current Price:</strong> <span id="modalCurrentPrice"></span></p>
            <p><strong>Gain/Loss:</strong> <span id="modalGainLoss"></span></p>
            <p><strong>Dividend Yield:</strong> <span id="modalDividendYield"></span></p>
            <div id="modalCommentsContainer">
                </div>
            <p class="small-text-link">Prices from <a href="https://www.commsec.com.au/markets/prices.html" target="_blank" rel="noopener noreferrer">CommSec</a></p>
            <p id="commSecLoginMessage" class="small-text-ghosted">You may need to log in to CommSec to view prices.</p>
            <button id="editShareFromDetailsBtn" class="edit-btn">Edit Share</button>
            <button id="deleteShareFromDetailsBtn" class="delete-btn">Delete Share</button>
        </div>
    </div>

    <div id="calculatorModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="calculatorModal">&times;</span>
            <h2>Share Calculator</h2>
            <form id="calculatorForm">
                <label for="calcSharesOwned">Shares Owned:</label>
                <input type="number" id="calcSharesOwned" placeholder="e.g., 1000" min="0">

                <label for="calcPurchasePrice">Purchase Price (per share):</label>
                <input type="number" id="calcPurchasePrice" step="0.01" placeholder="e.g., 90.00" min="0">

                <label for="calcCurrentPrice">Current Price (per share):</label>
                <input type="number" id="calcCurrentPrice" step="0.01" placeholder="e.g., 95.00" min="0">

                <label for="calcDividendYield">Dividend Yield (%):</label>
                <input type="number" id="calcDividendYield" step="0.01" placeholder="e.g., 4.2" min="0">

                <label for="calcBrokerageBuy">Brokerage (Buy):</label>
                <input type="number" id="calcBrokerageBuy" step="0.01" placeholder="e.g., 10.00" min="0">

                <label for="calcBrokerageSell">Brokerage (Sell):</label>
                <input type="number" id="calcBrokerageSell" step="0.01" placeholder="e.g., 10.00" min="0">

                <button type="button" id="calculateBtn">Calculate</button>
            </form>

            <div id="calculatorResults" class="results-section hidden">
                <h3>Results:</h3>
                <p><strong>Total Purchase Cost:</strong> <span id="resultPurchaseCost"></span></p>
                <p><strong>Current Value:</strong> <span id="resultCurrentValue"></span></p>
                <p><strong>Gross Gain/Loss:</strong> <span id="resultGrossGainLoss"></span></p>
                <p><strong>Net Gain/Loss:</strong> <span id="resultNetGainLoss"></span></p>
                <p><strong>Percentage Gain/Loss:</strong> <span id="resultPercentageGainLoss"></span></p>
                <p><strong>Annual Dividends:</strong> <span id="resultAnnualDividends"></span></p>
            </div>
        </div>
    </div>

    <div id="customDialogModal" class="modal">
        <div class="modal-content small-modal">
            <p id="customDialogMessage"></p>
            <div class="custom-dialog-buttons">
                <button id="customDialogConfirmBtn" class="confirm-btn">OK</button>
                <button id="customDialogCancelBtn" class="cancel-btn hidden">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, writeBatch, FieldValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInAnonymously, signInWithCustomToken, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace with your actual API Key
            authDomain: "YOUR_AUTH_DOMAIN", // Replace with your actual Auth Domain
            projectId: "YOUR_PROJECT_ID", // Replace with your actual Project ID
            storageBucket: "YOUR_STORAGE_BUCKET", // Replace with your actual Storage Bucket
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // Replace with your actual Messaging Sender ID
            appId: "YOUR_APP_ID", // Replace with your actual App ID
            measurementId: "YOUR_MEASUREMENT_ID" // Replace with your actual Measurement ID (optional)
        };

        let app;
        let db;
        let auth;
        let firebaseInitialized = false;
        let currentAppId = null;

        // Initialize Firebase only once
        if (!getApps().length) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            firebaseInitialized = true;
            currentAppId = firebaseConfig.appId;
            console.log("Firebase initialized successfully.");
        } else {
            // If already initialized, get the existing app
            app = getApp();
            db = getFirestore(app);
            auth = getAuth(app);
            if (app.options.appId === firebaseConfig.appId) {
                firebaseInitialized = true;
                currentAppId = firebaseConfig.appId;
                console.log("Firebase already initialized, reusing existing app.");
            } else {
                console.warn("Firebase was initialized with a different app ID. Reinitializing may be required for specific features.");
                // Potentially reinitialize or handle error if app ID mismatch is critical
                // For now, setting firebaseInitialized to false to prevent using misconfigured instances
                firebaseInitialized = false;
            }
        }

        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId;
        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete,
            writeBatch: writeBatch // Exposed writeBatch
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html (v47) script module loaded and DOMContentLoaded fired."); // Updated version number
        }); 
    </script>
    <script src="script.js?v=108"></script>
</body>
</html>