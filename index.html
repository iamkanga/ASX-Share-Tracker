<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Share Tracker</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK Imports and Initialization -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Import all required auth functions directly
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, linkWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // VITAL STEP: REPLACE THE ENTIRE BLOCK BELOW WITH YOUR ACTUAL firebaseConfig
        // You MUST copy this from your Firebase Console -> Project settings -> "Your apps" section -> Web app -> "Config" snippet.
        // It should start with 'const firebaseConfig = {' and end with '};'
        const firebaseConfig = {
            apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw", // YOUR_API_KEY_HERE (from your previous config)
            authDomain: "asx-watchlist-app.firebaseapp.com",   // YOUR_AUTH_DOMAIN_HERE (from your previous config)
            projectId: "asx-watchlist-app",                    // YOUR_PROJECT_ID_HERE (from your previous config)
            storageBucket: "asx-watchlist-app.firebasestorage.app",
            messagingSenderId: "671024168765",
            appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54",
            // measurementId: "G-J24BTJ34D2" // Only if present in your Firebase Console config
        };
        // END VITAL STEP

        // Determine the appId. Use __app_id from Canvas if available, otherwise use the projectId from firebaseConfig.
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        // The initialAuthToken is only provided in the Canvas environment. For live deployment, it will be null.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase app, Firestore, and Auth instances
        let app;
        let db;
        let auth;
        let userId = null; // Variable to store the authenticated user's ID

        // Make Firebase instances and functions globally accessible to script.js.
        // This is necessary because script.js is not a module itself.
        window.firebaseApp = null;
        window.firestoreDb = null;
        window.firebaseAuth = null;
        window.getFirebaseUserId = () => userId; // Getter for the current user ID
        window.getFirebaseAppId = () => appId; // Getter for the current app ID

        // Expose specific Firestore functions globally for use in script.js
        window.firestore = {
            collection: (db, path) => collection(db, path),
            addDoc: (collectionRef, data) => addDoc(collectionRef, data),
            getDocs: (queryRef) => getDocs(queryRef),
            doc: (db, path, docId) => doc(db, path, docId),
            updateDoc: (docRef, data) => updateDoc(docRef, data),
            deleteDoc: (docRef) => deleteDoc(docRef),
            query: (collectionRef, ...queryConstraints) => query(collectionRef, ...queryConstraints),
            where: (field, op, value) => where(field, op, value),
        };

        // Expose specific Auth functions globally for use in script.js
        // IMPORTANT: Directly expose the imported functions!
        window.authFunctions = {
            GoogleAuthProvider: GoogleAuthProvider,
            signInWithPopup: signInWithPopup, // Correct: Directly expose the imported function
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged,
            signInAnonymously: signInAnonymously,
            linkWithPopup: linkWithPopup // Correct: Directly expose the imported function
        };

        // Function to handle user authentication (anonymous for simplicity in this app)
        async function authenticateAndInitializeFirebase() {
            try {
                // Initialize app and services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); // auth object is now defined here

                // Make instances truly available globally AFTER initialization
                window.firebaseApp = app;
                window.firestoreDb = db;
                window.firebaseAuth = auth;

                // Configure GoogleAuthProvider instance for explicit redirect URL
                const googleProvider = new GoogleAuthProvider();
                googleProvider.setCustomParameters({'redirect_uri': 'https://iamkanga.github.io/ASX-Share-Tracker/__/auth/handler'});
                window.authFunctions.GoogleAuthProviderInstance = googleProvider; // Expose the configured provider

                // Handle initial authentication: prioritize Canvas token, then anonymous.
                if (initialAuthToken) { // This path is used when running in the Canvas environment
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token (Canvas).");
                        userId = auth.currentUser.uid;
                        window.dispatchEvent(new CustomEvent('firebaseServicesReady')); // Notify script.js
                    } catch (customTokenError) {
                        console.warn("Custom token sign-in failed, attempting anonymous auth:", customTokenError.message);
                        await signInAnonymously(auth); // Fallback to anonymous if custom token fails
                        userId = auth.currentUser.uid;
                        window.dispatchEvent(new CustomEvent('firebaseServicesReady')); // Notify script.js
                    }
                } else { // This path is used for live deployment (GitHub Pages)
                    await signInAnonymously(auth); // Always sign in anonymously on initial load if no persistent user
                    userId = auth.currentUser.uid;
                    console.log("Signed in anonymously (Live deployment).");
                    window.dispatchEvent(new CustomEvent('firebaseServicesReady')); // Notify script.js
                }

            } catch (error) {
                console.error("Firebase authentication/initialization failed:", error);
                // Display error message and disable input/button if authentication fails
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.textContent = "Failed to load app. Check console for errors or refresh.";
                }
                const addShareBtn = document.getElementById('addShareBtn');
                if (addShareBtn) {
                    addShareBtn.disabled = true;
                }
            }
        }

        // Only call authentication and Firebase initialization AFTER the entire window is loaded
        window.onload = authenticateAndInitializeFirebase;

        // The main onAuthStateChanged listener will now reside ONLY in script.js
        // to manage UI updates and data loading after Firebase services are ready.
    </script>
</head>
<body>
    <h1>My ASX Share Watchlist</h1>
    <p>Logged in as: <span id="displayUserName">Loading...</span> (<span id="displayUserId">Loading...</span>)</p>
    <button id="googleSignInBtn" style="display:none;">Sign in with Google</button>
    <button id="googleSignOutBtn" style="display:none;">Sign Out</button>
    <div id="loadingIndicator" class="loading">App is loading...</div>

    <div class="input-section">
        <h2>Add/Edit Share</h2>
        <input type="text" id="shareName" placeholder="Share Name (e.g., CBA)">
        <input type="number" id="currentPrice" placeholder="Current Price">
        <input type="number" id="targetPrice" placeholder="Target Price">
        <input type="number" id="dividendAmount" placeholder="Dividend Amount (e.g., 1.50)">
        <input type="number" id="frankingCredits" placeholder="Franking Credits (e.g., 70 for 70%)">
        <textarea id="comments" placeholder="Your comments/thoughts"></textarea>
        <button id="addShareBtn" disabled>Add Share</button>
    </div>

    <div class="share-list-section">
        <h2>Watchlist</h2>
        <table id="shareTable">
            <thead>
                <tr>
                    <th>Entry Date</th>
                    <th>Share Name</th>
                    <th>Current Price</th>
                    <th>Target Price</th>
                    <th>Dividend Amount</th>
                    <th>Franking Credits</th>
                    <th>Comments</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Share data will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal for displaying detailed share information -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName"></h2>
            <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
            <p><strong>Current Price:</strong> <span id="modalCurrentPrice"></span></p>
            <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
            <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
            <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
            <p><strong>Comments:</strong> <span id="modalComments"></span></p>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
