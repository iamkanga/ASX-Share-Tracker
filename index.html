<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Share Tracker</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK Imports and Initialization -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Important: Include all Auth functions that will be used (getAuth, signInAnonymously,
        // GoogleAuthProvider, signInWithRedirect, signOut, getRedirectResult, onAuthStateChanged)
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithRedirect, signOut, getRedirectResult, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // YOUR ACTUAL FIREBASE PROJECT CONFIGURATION (provided by you)
        const firebaseConfig = {
            apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw",
            authDomain: "asx-watchlist-app.firebaseapp.com",
            projectId: "asx-watchlist-app",
            storageBucket: "asx-watchlist-app.firebasestorage.app",
            messagingSenderId: "671024168765",
            appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54",
            measurementId: "G-J24BTJ34D2"
        };
        // END OF FIREBASE CONFIGURATION

        // Determine the appId. Use __app_id from Canvas if available, otherwise use the projectId from firebaseConfig.
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // Initialize Firebase app, Firestore, and Auth instances (declare globally for this module)
        let app;
        let db;
        let auth;
        let currentUserId = null; // Holds the current user's UID

        // Make Firebase instances and functions globally accessible to script.js
        window.firebaseApp = null;
        window.firestoreDb = null;
        window.firebaseAuth = null;
        window.getFirebaseAppId = () => appId;

        // Expose specific Firebase Auth and Firestore functions globally for use in script.js
        window.firestore = {
            collection: (dbInstance, path) => collection(dbInstance, path),
            addDoc: (collectionRef, data) => addDoc(collectionRef, data),
            getDocs: (queryRef) => getDocs(queryRef),
            doc: (dbInstance, path, docId) => doc(dbInstance, path, docId),
            updateDoc: (docRef, data) => updateDoc(docRef, data),
            deleteDoc: (docRef) => deleteDoc(docRef),
            query: (collectionRef, ...queryConstraints) => query(collectionRef, ...queryConstraints),
            where: (field, op, value) => where(field, op, value),
        };
        // Expose specific Auth functions for use in script.js for button click handlers
        window.authFunctions = {
            GoogleAuthProvider: GoogleAuthProvider,
            signInWithRedirect: signInWithRedirect,
            signOut: signOut,
            signInAnonymously: signInAnonymously,
            getRedirectResult: getRedirectResult,
            onAuthStateChanged: onAuthStateChanged // Expose for completeness, but main listener is here
        };

        // Function to authenticate and initialize Firebase, setting up the primary auth listener
        async function authenticateAndInitializeFirebase() {
            try {
                // Initialize Firebase services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Make instances truly available globally AFTER initialization
                window.firebaseApp = app;
                window.firestoreDb = db;
                window.firebaseAuth = auth;

                // Get UI elements
                const loadingIndicator = document.getElementById('loadingIndicator');
                const displayUserIdSpan = document.getElementById('displayUserId');
                const displayUserNameSpan = document.getElementById('displayUserName');
                const googleSignInBtn = document.getElementById('googleSignInBtn');
                const googleSignOutBtn = document.getElementById('googleSignOutBtn');
                const addShareBtn = document.getElementById('addShareBtn');
                // Select all inputs and textarea in the input-section for disabling/enabling
                const formInputs = document.querySelectorAll('.input-section input, .input-section textarea');

                // *** Primary Authentication State Listener ***
                // This listener will be the single source of truth for auth state and UI updates
                onAuthStateChanged(auth, async (user) => {
                    currentUserId = user ? user.uid : null; // Update currentUserId globally

                    if (user) {
                        // A user is signed in (could be anonymous or persistent)
                        if (displayUserIdSpan) displayUserIdSpan.textContent = user.uid;
                        if (displayUserNameSpan) displayUserNameSpan.textContent = user.displayName || user.email || 'Guest';

                        if (user.isAnonymous) {
                            // Currently anonymous user
                            if (displayUserNameSpan) displayUserNameSpan.textContent += " (Anonymous)";
                            if (googleSignInBtn) googleSignInBtn.style.display = 'block'; // Show Sign In
                            if (googleSignOutBtn) googleSignOutBtn.style.display = 'none'; // Hide Sign Out
                            if (addShareBtn) addShareBtn.disabled = true; // Disable inputs/button for anonymous
                            formInputs.forEach(input => { if (input) input.disabled = true; });
                            console.log("Auth State: Anonymous User. ID:", user.uid);
                        } else {
                            // Persistent user (e.g., Google-signed in)
                            if (googleSignInBtn) googleSignInBtn.style.display = 'none'; // Hide Sign In
                            if (googleSignOutBtn) googleSignOutBtn.style.display = 'block'; // Show Sign Out
                            if (addShareBtn) addShareBtn.disabled = false; // Enable inputs/button for persistent
                            formInputs.forEach(input => { if (input) input.disabled = false; });
                            console.log("Auth State: Persistent User. ID:", user.uid, "Email:", user.email);
                        }
                        // Dispatch event to script.js to signal data can be loaded
                        window.dispatchEvent(new CustomEvent('firebaseAuthReady', { detail: { userId: user.uid, user: user } }));

                    } else {
                        // No user signed in (initial load or after explicit sign-out).
                        // Attempt anonymous sign-in to ensure a base user session is always present.
                        console.log("Auth State: No user. Attempting anonymous sign-in...");
                        if (displayUserIdSpan) displayUserIdSpan.textContent = "Not logged in";
                        if (displayUserNameSpan) displayUserNameSpan.textContent = "Guest";
                        if (googleSignInBtn) googleSignInBtn.style.display = 'block';
                        if (googleSignOutBtn) googleSignOutBtn.style.display = 'none';
                        if (addShareBtn) addShareBtn.disabled = true;
                        formInputs.forEach(input => { if (input) input.disabled = true; });

                        try {
                            const anonUserCredential = await signInAnonymously(auth);
                            currentUserId = anonUserCredential.user.uid; // Update to new anonymous UID
                            if (displayUserIdSpan) displayUserIdSpan.textContent = currentUserId + " (Anonymous)";
                            if (displayUserNameSpan) displayUserNameSpan.textContent = "Guest (Anonymous)";
                            console.log("Anonymous sign-in successful. User ID:", currentUserId);
                            window.dispatchEvent(new CustomEvent('firebaseAuthReady', { detail: { userId: currentUserId, user: anonUserCredential.user } }));
                        } catch (anonError) {
                            console.error("Anonymous sign-in failed during onAuthStateChanged:", anonError);
                            if (displayUserIdSpan) displayUserIdSpan.textContent = "Auth Error";
                            if (displayUserNameSpan) displayUserNameSpan.textContent = "Error";
                        }
                    }
                    if (loadingIndicator) loadingIndicator.style.display = 'none'; // Hide loading once auth state is fully determined
                });

                // Handle Google Sign-in redirect result immediately after onAuthStateChanged is set up.
                // This will trigger the onAuthStateChanged listener above with the persistent user.
                try {
                    const redirectResult = await getRedirectResult(auth);
                    if (redirectResult) {
                        console.log("Google redirect result processed. User:", redirectResult.user.uid, "Display Name:", redirectResult.user.displayName);
                        // The onAuthStateChanged listener will handle the UI update based on this result.
                    }
                } catch (error) {
                    console.error("Error during Google redirect result:", error.code, error.message);
                    if (error.code === 'auth/account-exists-with-different-credential') {
                        // This specific error means user tried to sign in with an email already linked to another method.
                        // Sign out the current (likely anonymous) user and prompt them to retry.
                        await signOut(auth); // Sign out the conflicting session
                        alert("This email is already associated with another sign-in method in Firebase. You have been signed out. Please click 'Sign in with Google' again to connect your account.");
                    } else {
                        alert("Google Sign-in failed after redirect. Please try again. Check browser console for details.");
                    }
                }

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.textContent = "Critical error loading app. Check console.";
                }
                const addShareBtn = document.getElementById('addShareBtn');
                if (addShareBtn) {
                    addShareBtn.disabled = true;
                }
                const formInputs = document.querySelectorAll('.input-section input, .input-section textarea');
                formInputs.forEach(input => { if (input) input.disabled = true; });
            }
        }

        // Call the main authentication and initialization function once the window is fully loaded
        window.onload = authenticateAndInitializeFirebase;

    </script>
</head>
<body>
    <h1>My ASX Share Watchlist</h1>
    <p>Logged in as: <span id="displayUserName">Loading...</span> (<span id="displayUserId">Loading...</span>)</p>
    <button id="googleSignInBtn" style="display:none;">Sign in with Google</button>
    <button id="googleSignOutBtn" style="display:none;">Sign Out</button>
    <div id="loadingIndicator" class="loading">App is loading...</div>

    <div class="input-section">
        <h2>Add/Edit Share</h2>
        <input type="text" id="shareName" placeholder="Share Name (e.g., CBA)">
        <input type="number" id="currentPrice" placeholder="Current Price">
        <input type="number" id="targetPrice" placeholder="Target Price">
        <input type="number" id="dividendAmount" placeholder="Dividend Amount (e.g., 1.50)">
        <input type="number" id="frankingCredits" placeholder="Franking Credits (e.g., 70 for 70%)">
        <textarea id="comments" placeholder="Your comments/thoughts"></textarea>
        <button id="addShareBtn" disabled>Add Share</button>
    </div>

    <div class="share-list-section">
        <h2>Watchlist</h2>
        <table id="shareTable">
            <thead>
                <tr>
                    <th>Entry Date</th>
                    <th>Share Name</th>
                    <th>Current Price</th>
                    <th>Target Price</th>
                    <th>Dividend Amount</th>
                    <th>Franking Credits</th>
                    <th>Comments</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Share data will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal for displaying detailed share information -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName"></h2>
            <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
            <p><strong>Current Price:</strong> <span id="modalCurrentPrice"></span></p>
            <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
            <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
            <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
            <p><strong>Comments:</strong> <span id="modalComments"></span></p>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
