<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Share Tracker</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK Imports and Initialization -->
    <script type="module">
        console.log("INDEX.HTML: Top of module script. (LOG 1)");

        // Import ALL necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, linkWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        console.log("INDEX.HTML: All Firebase SDKs imported. (LOG 2)");

        const firebaseConfig = {
            apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw",
            authDomain: "asx-watchlist-app.firebaseapp.com",
            projectId: "asx-watchlist-app",
            storageBucket: "asx-watchlist-app.firebasestorage.app",
            messagingSenderId: "671024168765",
            appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54",
            measurementId: "G-J24BTJ34D2"
        };

        const appId = firebaseConfig.projectId;

        let app, db, auth;

        try {
            console.log("INDEX.HTML: Attempting initializeApp... (LOG 3)");
            app = initializeApp(firebaseConfig);
            console.log("INDEX.HTML: initializeApp successful. Attempting getFirestore... (LOG 4)");
            db = getFirestore(app);
            console.log("INDEX.HTML: getFirestore successful. Attempting getAuth... (LOG 5)");
            auth = getAuth(app);
            console.log("INDEX.HTML: getAuth successful. Exposing globals... (LOG 6)");

            window.firebaseApp = app;
            window.firestoreDb = db;
            window.firebaseAuth = auth;
            window.getFirebaseAppId = () => appId;

            window.firestore = {
                collection: (dbInstance, path) => collection(dbInstance, path),
                addDoc: (collectionRef, data) => addDoc(collectionRef, data),
                getDocs: (queryRef) => getDocs(queryRef),
                doc: (dbInstance, path, docId) => doc(dbInstance, path, docId),
                updateDoc: (docRef, data) => updateDoc(docRef, data),
                deleteDoc: (docRef) => deleteDoc(docRef),
                query: (collectionRef, ...queryConstraints) => query(collectionRef, ...queryConstraints),
                where: (field, op, value) => where(field, op, value),
            };
            window.authFunctions = {
                GoogleAuthProvider: GoogleAuthProvider,
                signInWithPopup: signInWithPopup,
                signOut: signOut,
                onAuthStateChanged: onAuthStateChanged,
                signInAnonymously: signInAnonymously,
                linkWithPopup: linkWithPopup
            };
            console.log("INDEX.HTML: All Firebase functions exposed globally. (LOG 7)");


            // --- Primary Authentication State Listener (in index.html) ---
            // This is the single source of truth for auth state and UI updates.
            onAuthStateChanged(auth, async (user) => {
                console.log("INDEX.HTML: onAuthStateChanged callback fired. User:", user ? user.uid : "null. (LOG 8)");

                const loadingIndicator = document.getElementById('loadingIndicator');
                const signInButton = document.getElementById('googleSignInBtn');
                const signOutButton = document.getElementById('googleSignOutBtn');
                const displayUserIdSpan = document.getElementById('displayUserId');
                const displayUserNameSpan = document.getElementById('displayUserName');
                const addShareBtn = document.getElementById('addShareBtn');
                // Select all inputs and textarea in the input-section, and the addShareBtn
                const formInputsAndButton = document.querySelectorAll('.input-section input, .input-section textarea, #addShareBtn');

                if (user) {
                    const userId = user.uid;
                    if (displayUserIdSpan) displayUserIdSpan.textContent = userId;

                    if (user.isAnonymous) {
                        if (displayUserNameSpan) displayUserNameSpan.textContent = "Guest (Anonymous)";
                        if (signInButton) signInButton.style.display = 'block'; // Show sign-in for anonymous
                        if (signOutButton) signOutButton.style.display = 'none';
                        formInputsAndButton.forEach(element => { if (element) element.disabled = true; }); // Disable for anonymous
                        console.log("INDEX.HTML: User authenticated (Anonymous). ID:", userId);
                    } else {
                        if (displayUserNameSpan) displayUserNameSpan.textContent = user.displayName || user.email;
                        if (signInButton) signInButton.style.display = 'none'; // Hide sign-in for persistent
                        if (signOutButton) signOutButton.style.display = 'block'; // Show sign-out for persistent
                        formInputsAndButton.forEach(element => { if (element) element.disabled = false; }); // Enable for persistent
                        console.log("INDEX.HTML: User authenticated (Persistent). ID:", userId);
                    }
                    if (loadingIndicator) loadingIndicator.style.display = 'none'; // Hide loading once any auth state is determined
                    window.dispatchEvent(new CustomEvent('firebaseAuthReady', { detail: { userId: userId, user: user } }));
                    console.log("INDEX.HTML: Dispatched 'firebaseAuthReady' event. (LOG 9)");

                } else {
                    // No user signed in (initial load or explicit sign out)
                    console.log("INDEX.HTML: No user found initially or user signed out. (LOG 10)");
                    if (displayUserIdSpan) displayUserIdSpan.textContent = "Not logged in";
                    if (displayUserNameSpan) displayUserNameSpan.textContent = "Guest";
                    if (signInButton) signInButton.style.display = 'block'; // Always show sign-in if no user
                    if (signOutButton) signOutButton.style.display = 'none';
                    formInputsAndButton.forEach(element => { if (element) element.disabled = true; }); // Keep disabled until persistent login
                    if (loadingIndicator) loadingIndicator.style.display = 'block'; // Keep loading visible while attempting anonymous

                    // Attempt anonymous sign-in if no user is currently authenticated at all
                    // This handles scenarios where there's no persistent session.
                    signInAnonymously(auth).then(anonUserCredential => {
                        const userId = anonUserCredential.user.uid;
                        if (displayUserIdSpan) displayUserIdSpan.textContent = userId + " (Anonymous)";
                        if (displayUserNameSpan) displayUserNameSpan.textContent = "Guest (Anonymous)";
                        if (signInButton) signInButton.style.display = 'block'; // Still show sign-in for anonymous
                        if (signOutButton) signOutButton.style.display = 'none';
                        formInputsAndButton.forEach(element => { if (element) element.disabled = true; });
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        window.dispatchEvent(new CustomEvent('firebaseAuthReady', { detail: { userId: userId, user: anonUserCredential.user } }));
                        console.log("INDEX.HTML: Signed in anonymously. User ID:", userId, "(LOG 11)");
                    }).catch(anonError => {
                        console.error("INDEX.HTML: Anonymous sign-in failed:", anonError);
                        if (loadingIndicator) loadingIndicator.textContent = "Failed to load app. Authentication error.";
                        if (loadingIndicator) loadingIndicator.style.display = 'block'; // Keep showing error
                    });
                }
            });

        } catch (error) {
            console.error("INDEX.HTML: CRITICAL FIREBASE INIT ERROR:", error); // LOG CRITICAL_ERROR
            window.firebaseInitError = true;
            if (document.getElementById('loadingIndicator')) {
                document.getElementById('loadingIndicator').textContent = `CRITICAL ERROR: App failed to load. Check console for details.`;
            }
        }
    </script>
</head>
<body>
    <h1>My ASX Share Watchlist</h1>
    <p>Logged in as: <span id="displayUserName">Loading...</span> (<span id="displayUserId">Loading...</span>)</p>
    <button id="googleSignInBtn" style="display:none;">Sign in with Google</button>
    <button id="googleSignOutBtn" style="display:none;">Sign Out</button>
    <div id="loadingIndicator" class="loading">App is loading...</div>

    <div class="input-section">
        <h2>Add/Edit Share</h2>
        <input type="text" id="shareName" placeholder="Share Name (e.g., CBA)">
        <input type="number" id="currentPrice" placeholder="Current Price">
        <input type="number" id="targetPrice" placeholder="Target Price">
        <input type="number" id="dividendAmount" placeholder="Dividend Amount (e.g., 1.50)">
        <input type="number" id="frankingCredits" placeholder="Franking Credits (e.g., 70 for 70%)">
        <textarea id="comments" placeholder="Your comments/thoughts"></textarea>
        <button id="addShareBtn" disabled>Add Share</button>
    </div>

    <div class="share-list-section">
        <h2>Watchlist</h2>
        <table id="shareTable">
            <thead>
                <tr>
                    <th>Entry Date</th>
                    <th>Share Name</th>
                    <th>Current Price</th>
                    <th>Target Price</th>
                    <th>Dividend Amount</th>
                    <th>Franking Credits</th>
                    <th>Comments</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Share data will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal for displaying detailed share information -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName"></h2>
            <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
            <p><strong>Current Price:</strong> <span id="modalCurrentPrice"></span></p>
            <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
            <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
            <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
            <p><strong>Comments:</strong> <span id="modalComments"></span></p>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
