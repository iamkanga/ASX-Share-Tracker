<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Share Tracker</title>
    <!-- Favicon: Eggplant emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÜ</text></svg>">

    <link rel="stylesheet" href="style.css?v=20"> <!-- Updated CSS version for new styles -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-top-row">
            <h1 id="mainTitle">My ASX Share Watchlist</h1>
            <!-- NEW: Theme Toggle Button -->
            <button id="themeToggleBtn" class="theme-toggle-btn"><i class="fas fa-moon"></i> Toggle Theme</button>
        </div>

        <!-- Consolidated Action Buttons Container -->
        <!-- All calculator and share action buttons are now in one row, under the main title. -->
        <div class="action-buttons-row">
            <button id="newShareBtn"><i class="fas fa-plus-circle"></i> Add New Share</button>
            <button id="viewDetailsBtn" disabled><i class="fas fa-info-circle"></i> View Details</button>
            <button id="standardCalcBtn"><i class="fas fa-calculator"></i> Standard</button>
            <button id="dividendCalcBtn"><i class="fas fa-money-bill-wave"></i> Dividend</button>
        </div>

        <!-- Watchlist and Sort controls (grouped for layout) -->
        <div class="watchlist-controls-row">
            <div class="watchlist-management-group">
                <label for="watchlistSelect" class="desktop-only-label">Select Watchlist:</label>
                <select id="watchlistSelect" class="dropdown-large">
                    <!-- Options populated by JS, including mobile placeholder -->
                </select>
                <button id="addWatchlistBtn" class="small-button"><i class="fas fa-folder-plus"></i> Add</button>
                <button id="renameWatchlistBtn" class="small-button"><i class="fas fa-edit"></i> Rename</button>
            </div>

            <div class="sort-controls-group">
                <label for="sortSelect" class="desktop-only-label">Sort By:</label>
                <select id="sortSelect" class="dropdown-large">
                    <!-- Mobile placeholder will be added by JS to the first position -->
                    <option value="entryDate-desc">Date Added (Newest)</option>
                    <option value="entryDate-asc">Date Added (Oldest)</option>
                    <option value="shareName-asc">ASX Code (A-Z)</option>
                    <option value="shareName-desc">ASX Code (Z-A)</option>
                    <option value="lastFetchedPrice-desc">Current Price (High-Low)</option>
                    <option value="lastFetchedPrice-asc">Current Price (Low-High)</option>
                    <option value="dividendAmount-desc">Dividend (High-Low)</option>
                    <option value="dividendAmount-asc">Dividend (Low-High)</option>
                </select>
            </div>
        </div>
        
        <!-- ASX Code buttons container (will be populated by JS and centered by CSS) -->
        <div id="asxCodeButtonsContainer" class="asx-code-buttons-container">
            <!-- ASX code buttons will be dynamically added here -->
        </div>
    </header>

    <main class="container">
        <!-- Message for Firebase initialization errors -->
        <div id="firebaseInitError" class="error-message" style="display: none;">
            <p><strong>Error:</strong> Firebase failed to initialize.</p>
            <p>This is usually due to missing or incorrect Firebase configuration. Please ensure your <code>firebaseConfig</code> in <code>index.html</code> is correctly set up from your Firebase project settings.</p>
            <p>Core application features will not work without a valid Firebase connection.</p>
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">Loading shares...</div>
        <div class="share-list-section">
            <div class="table-container">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>ASX Code</th>
                            <th>Current Price</th>
                            <th>Target Price</th>
                            <th>Dividends</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be dynamically added here -->
            </div>
        </div>
    </main>

    <footer class="fixed-footer">
        <button id="googleAuthBtn" class="google-auth-btn">Sign In</button>
    </footer>

    <!-- NEW: Scroll-to-Top Button -->
    <button id="scrollToTopBtn" title="Go to top"><i class="fas fa-arrow-up"></i></button>

    <!-- Modals -->
    <!-- Share Form Modal -->
    <div id="shareFormSection" class="modal">
        <div class="modal-content add-share-modal-content"> <!-- Added class for size control -->
            <span class="close-button form-close-button">&times;</span>
            <h2 id="formTitle">Add New Share</h2>
            <label for="shareName">ASX Code:</label>
            <input type="text" id="shareName" placeholder="e.g., BHP" required>

            <label for="currentPrice">Current Price ($):</label>
            <input type="number" id="currentPrice" step="0.01" placeholder="e.g., 25.50">

            <label for="targetPrice">Target Price ($):</label>
            <input type="number" id="targetPrice" step="0.01" placeholder="e.g., 30.00">

            <label for="dividendAmount">Dividend Amount (per share, annual $):</label>
            <input type="number" id="dividendAmount" step="0.001" placeholder="e.g., 1.250">

            <label for="frankingCredits">Franking Credits (%):</label>
            <input type="number" id="frankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70 for 70%">

            <div id="commentsFormContainer" class="comments-form-container">
                <h3>Comments <button type="button" id="addCommentSectionBtn" class="add-section-btn">+</button></h3>
                <!-- Comment sections will be dynamically added here by JS -->
            </div>

            <div class="form-action-buttons">
                <button type="button" id="deleteShareFromFormBtn" class="danger-button"><i class="fas fa-trash-alt"></i> Delete Share</button>
                <button type="button" id="cancelFormBtn" class="secondary-buttons"><i class="fas fa-times-circle"></i> Cancel</button>
                <button type="submit" id="saveShareBtn"><i class="fas fa-save"></i> Save Share</button>
            </div>
        </div>
    </div>

    <!-- Share Details Modal -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName">Share Details</h2>
            <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
            <p><strong>Current Price:</strong> <span id="modalCurrentPriceDetailed"></span></p>
            <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
            <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
            <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
            <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
            <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>

            <div id="modalCommentsContainer" class="modal-comments-sections">
                <h3>Comments</h3>
                <!-- Comments will be displayed here -->
            </div>

            <div class="modal-action-buttons">
                <button type="button" id="editShareFromDetailBtn"><i class="fas fa-edit"></i> Edit Share</button>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <span class="close-button calc-close-button">&times;</span>
            <h2>Dividend Calculator</h2>
            <div class="calc-input-group">
                <label for="calcDividendAmount">Annual Dividend Per Share ($):</label>
                <input type="number" id="calcDividendAmount" step="0.001" placeholder="e.g., 1.250">
            </div>
            <div class="calc-input-group">
                <label for="calcCurrentPrice">Current Share Price ($):</label>
                <input type="number" id="calcCurrentPrice" step="0.01" placeholder="e.g., 25.50">
            </div>
            <div class="calc-input-group">
                <label for="calcFrankingCredits">Franking Credits (%):</label>
                <input type="number" id="calcFrankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70">
            </div>
            <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">-</span></p>
            <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">-</span></p>
            <hr>
            <div class="calc-input-group">
                <label for="investmentValueSelect">Investment Value:</label>
                <select id="investmentValueSelect">
                    <option value="1000">$1,000</option>
                    <option value="5000">$5,000</option>
                    <option value="10000" selected>$10,000</option>
                    <option value="25000">$25,000</option>
                    <option value="50000">$50,000</option>
                    <option value="100000">$100,000</option>
                </select>
            </div>
            <p><strong>Estimated Annual Dividend:</strong> <span id="calcEstimatedDividend">-</span></p>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <span class="close-button">&times;</span>
            <h2>Standard Calculator</h2>
            <div class="calculator-display">
                <div id="calculatorInput" class="calculator-input"></div>
                <div id="calculatorResult" class="calculator-result">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="percentage">%</button>
                <button class="calc-btn operator" data-action="divide">√∑</button>
                <button class="calc-btn" data-value="7">7</button>
                <button class="calc-btn" data-value="8">8</button>
                <button class="calc-btn" data-value="9">9</button>
                <button class="calc-btn operator" data-action="multiply">√ó</button>
                <button class="calc-btn" data-value="4">4</button>
                <button class="calc-btn" data-value="5">5</button>
                <button class="calc-btn" data-value="6">6</button>
                <button class="calc-btn operator" data-action="subtract">-</button>
                <button class="calc-btn" data-value="1">1</button>
                <button class="calc-btn" data-value="2">2</button>
                <button class="calc-btn" data-value="3">3</button>
                <button class="calc-btn operator" data-action="add">+</button>
                <button class="calc-btn zero" data-value="0">0</button>
                <button class="calc-btn" data-value=".">.</button>
                <button class="calc-btn equals" data-action="calculate">=</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal for Alerts/Confirms -->
    <div id="customDialogModal" class="modal">
        <div class="modal-content">
            <p id="customDialogMessage"></p>
            <div class="custom-dialog-buttons">
                <button id="customDialogConfirmBtn" class="secondary-buttons">OK</button>
                <button id="customDialogCancelBtn" class="danger-button">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase and main script loading -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, FieldValue, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // YOUR FIREBASE CONFIGURATION - THIS HAS BEEN INSERTED BASED ON YOUR PROVIDED DETAILS
        const firebaseConfig = {
            apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw",
            authDomain: "asx-watchlist-app.firebaseapp.com",
            projectId: "asx-watchlist-app",
            storageBucket: "asx-watchlist-app.firebasestorage.app",
            messagingSenderId: "671024168765",
            appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54",
            measurementId: "G-J24BTJ34D2"
        };
        // END OF FIREBASE CONFIGURATION

        // Note: __app_id and __initial_auth_token are specific to the Canvas development environment.
        // For GitHub Pages, your Firebase project ID and app ID come directly from firebaseConfig above.
        const currentAppId = firebaseConfig.projectId || 'default-app-id'; // Use Firebase Project ID as app ID for hosted version

        // Initialize Firebase
        let firebaseApp;
        let auth;
        let db;
        let firebaseInitialized = false; // Flag to track successful initialization

        // Only initialize if config is valid (check for existence of apiKey and projectId)
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
            try {
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                firebaseInitialized = true;
                console.log("Firebase: Initialized successfully with config.");
            } catch (error) {
                console.error("Firebase: Failed to initialize app with provided config:", error);
                firebaseInitialized = false; // Ensure flag is false on error
            }
        } else {
            console.error("Firebase: Configuration is missing or invalid (apiKey or projectId). Firebase will not initialize.");
            const errorDiv = document.getElementById('firebaseInitError');
            if (errorDiv) {
                errorDiv.style.display = 'block'; // Make the error message visible
            }
            firebaseInitialized = false;
        }

        // Expose Firebase objects and auth functions globally for script.js
        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId; // Now uses the project ID from your firebaseConfig
        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete // Expose deleteField for migrations
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken, // Still included for compatibility, but might not be directly used for initial auth flow on GH Pages
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;


        // Authenticate when the DOM is fully loaded for the module script itself
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html (v24) script module loaded and DOMContentLoaded fired.");
            // We removed the custom event dispatch here, script.js will pick up firebaseAuth directly.
        }); 
    </script>
    <script src="script.js"></script>
</body>
</html>
