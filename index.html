<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Share Tracker</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK Imports and Initialization -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Import specific auth functions. Removed signInWithCustomToken as it's for Canvas only.
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // YOUR ACTUAL FIREBASE PROJECT CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw",
            authDomain: "asx-watchlist-app.firebaseapp.com",
            projectId: "asx-watchlist-app",
            storageBucket: "asx-watchlist-app.firebasestorage.app",
            messagingSenderId: "671024168765",
            appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54",
            measurementId: "G-J24BTJ34D2"
        };
        // END OF FIREBASE CONFIGURATION

        // Determine the appId for Firestore paths.
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // --- Initialize Firebase App, Auth, Firestore, and Google Provider IMMEDIATELY ---
        // These are const as they are instantiated once.
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider(); // Instantiate Google Auth Provider here

        // --- Expose these instances and essential functions DIRECTLY on the window object ---
        // This makes them globally accessible to script.js without complex wrapping.
        window.myFirebaseApp = app;
        window.myFirebaseAuth = auth;
        window.myFirestoreDb = db;
        window.myGoogleAuthProvider = googleProvider; // The *instance* of GoogleAuthProvider
        window.mySignInWithPopup = signInWithPopup;   // The signInWithPopup function itself
        window.mySignOut = signOut;                   // The signOut function itself
        window.getAppId = () => appId;                // Getter for the appId

        // Expose specific Firestore utility functions globally
        window.firestoreUtils = {
            collection: collection,
            addDoc: addDoc,
            getDocs: getDocs,
            doc: doc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            query: query,
            where: where,
        };

        // --- Main Authentication State Management ---
        window.onload = function() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const signInButton = document.getElementById('googleSignInBtn');
            const signOutButton = document.getElementById('googleSignOutBtn');
            const displayUserIdSpan = document.getElementById('displayUserId');
            const displayUserNameSpan = document.getElementById('displayUserName');
            const formElementsToDisable = document.querySelectorAll('.input-section input, .input-section textarea, #addShareBtn');

            onAuthStateChanged(auth, async (user) => {
                let currentUserId = null;
                if (user) {
                    currentUserId = user.uid;
                    if (displayUserIdSpan) displayUserIdSpan.textContent = currentUserId + (user.isAnonymous ? " (Anonymous)" : "");
                    if (displayUserNameSpan) displayUserNameSpan.textContent = user.displayName || user.email || 'Guest';

                    if (signInButton) signInButton.style.display = user.isAnonymous ? 'block' : 'none';
                    if (signOutButton) signOutButton.style.display = user.isAnonymous ? 'none' : 'block';

                    formElementsToDisable.forEach(element => { if(element) element.disabled = user.isAnonymous; });
                    if (loadingIndicator) loadingIndicator.style.display = 'none';

                    // Dispatch event to script.js only when auth state has settled
                    window.dispatchEvent(new CustomEvent('firebaseAuthReady', { detail: { userId: currentUserId, user: user } }));
                    console.log("Auth state changed. Current User ID:", currentUserId);
                } else {
                    // No user signed in (initial load or signed out). Attempt anonymous sign-in.
                    if (!auth.currentUser) {
                         console.log("No persistent user found. Attempting anonymous sign-in.");
                        try {
                            const anonUserCredential = await signInAnonymously(auth);
                            // onAuthStateChanged will fire again with the new anonymous user, handling UI update
                        } catch (anonError) {
                            console.error("Anonymous sign-in failed:", anonError);
                            if (loadingIndicator) loadingIndicator.textContent = "Failed to load app. Authentication error.";
                            formElementsToDisable.forEach(element => { if(element) element.disabled = true; });
                        }
                    } else {
                         // This branch is mainly for explicit sign-out, ensuring UI reflects logged-out state
                         if (displayUserIdSpan) displayUserIdSpan.textContent = "Not logged in";
                         if (displayUserNameSpan) displayUserNameSpan.textContent = "Guest";
                         if (signInButton) signInButton.style.display = 'block';
                         if (signOutButton) signOutButton.style.display = 'none';
                         formElementsToDisable.forEach(element => { if(element) element.disabled = true; });
                         if (loadingIndicator) loadingIndicator.style.display = 'none';
                         window.dispatchEvent(new CustomEvent('firebaseAuthReady', { detail: { userId: null, user: null } }));
                         console.log("User signed out and no new anonymous session.");
                    }
                }
            });
        };

        // For Canvas environment's initial auth (does not apply to GitHub Pages)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (initialAuthToken && typeof signInWithCustomToken !== 'undefined') {
            // This is called outside window.onload as Canvas might have its own lifecycle
            // Added check for signInWithCustomToken existence in case of different Firebase SDK versions
            getAuth(app).signInWithCustomToken(initialAuthToken)
                .then(() => console.log("Canvas custom token sign-in attempted."))
                .catch(error => console.warn("Canvas custom token failed:", error.message));
        }
    </script>
</head>
<body>
    <h1>My ASX Share Watchlist</h1>
    <p>Logged in as: <span id="displayUserName">Loading...</span> (<span id="displayUserId">Loading...</span>)</p>
    <button id="googleSignInBtn" style="display:none;">Sign in with Google</button>
    <button id="googleSignOutBtn" style="display:none;">Sign Out</button>
    <div id="loadingIndicator" class="loading">App is loading...</div>

    <div class="input-section">
        <h2>Add/Edit Share</h2>
        <input type="text" id="shareName" placeholder="Share Name (e.g., CBA)">
        <input type="number" id="currentPrice" placeholder="Current Price">
        <input type="number" id="targetPrice" placeholder="Target Price">
        <input type="number" id="dividendAmount" placeholder="Dividend Amount (e.g., 1.50)">
        <input type="number" id="frankingCredits" placeholder="Franking Credits (e.g., 70 for 70%)">
        <textarea id="comments" placeholder="Your comments/thoughts"></textarea>
        <button id="addShareBtn" disabled>Add Share</button>
    </div>

    <div class="share-list-section">
        <h2>Watchlist</h2>
        <table id="shareTable">
            <thead>
                <tr>
                    <th>Entry Date</th>
                    <th>Share Name</th>
                    <th>Current Price</th>
                    <th>Target Price</th>
                    <th>Dividend Amount</th>
                    <th>Franking Credits</th>
                    <th>Comments</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Share data will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal for displaying detailed share information -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName"></h2>
            <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
            <p><strong>Current Price:</strong> <span id="modalCurrentPrice"></span></p>
            <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
            <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
            <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
            <p><strong>Comments:</strong> <span id="modalComments"></span></p>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
