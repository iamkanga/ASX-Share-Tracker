<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Share Tracker</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration - DIRECTLY EMBEDDED
        const firebaseConfig = {
            apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw",
            authDomain: "asx-watchlist-app.firebaseapp.com",
            projectId: "asx-watchlist-app",
            storageBucket: "asx-watchlist-app.firebasestorage.app",
            messagingSenderId: "671024168765",
            appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54",
            measurementId: "G-J24BTJ34D2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null; // To store the authenticated user's ID
        const currentAppId = firebaseConfig.appId; // Use appId directly from config

        // Function to sign in anonymously
        async function authenticateUser() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase anonymous authentication failed:", error);
                alert("Failed to connect to the app (authentication error). Please try refreshing.");
            }
        }

        // Listen for auth state changes and dispatch event when ready
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                // Dispatch event to signal script.js that Firebase is ready
                window.dispatchEvent(new CustomEvent('firebaseAuthReady', { detail: { userId: userId } }));
            } else {
                console.log("User signed out. Attempting anonymous sign-in...");
                authenticateUser(); // Try to sign in if not authenticated
            }
        });

        // Make db, auth, and userId (and appId) globally accessible to script.js
        window.firebaseApp = app;
        window.firestoreDb = db;
        window.firebaseAuth = auth;
        window.getFirebaseUserId = () => userId;
        window.getFirebaseAppId = () => currentAppId;

        // Immediately attempt authentication if not already signed in (handles initial load)
        if (!auth.currentUser) {
            authenticateUser();
        }
    </script>
</head>
<body>
    <h1>My ASX Share Watchlist</h1>
    <p>Your User ID: <span id="displayUserId">Loading...</span></p>
    <div id="loadingIndicator" class="loading">App is loading...</div>

    <div class="input-section">
        <h2>Add/Edit Share</h2>
        <input type="text" id="shareName" placeholder="Share Name (e.g., CBA)">
        <input type="number" id="currentPrice" placeholder="Current Price">
        <input type="number" id="targetPrice" placeholder="Target Price">
        <input type="number" id="dividendAmount" placeholder="Dividend Amount (e.g., 1.50)">
        <input type="number" id="frankingCredits" placeholder="Franking Credits (e.g., 70 for 70%)">
        <textarea id="comments" placeholder="Your comments/thoughts"></textarea>
        <button id="addShareBtn" disabled>Add Share</button>
    </div>

    <div class="share-list-section">
        <h2>Watchlist</h2>
        <table id="shareTable">
            <thead>
                <tr>
                    <th>Entry Date</th>
                    <th>Share Name</th>
                    <th>Current Price</th>
                    <th>Target Price</th>
                    <th>Dividend Amount</th>
                    <th>Franking Credits</th>
                    <th>Comments</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Share data will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal for displaying detailed share information -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName"></h2>
            <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
            <p><strong>Current Price:</strong> <span id="modalCurrentPrice"></span></p>
            <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
            <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
            <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
            <p><strong>Comments:</strong> <span id="modalComments"></span></p>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
