<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Share Tracker</title>
    <!-- Favicon: Eggplant emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÜ</text></svg>">

    <link rel="stylesheet" href="style.css?v=27"> <!-- Updated CSS version for new styles -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-top-row">
            <!-- Hamburger Menu Button -->
            <button id="hamburgerBtn" class="hamburger-btn" aria-label="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="mainTitle">My ASX Share Watchlist</h1>
        </div>
        <div class="watchlist-controls-row">
            <div class="watchlist-group">
                <label for="watchlistSelect">Watchlist:</label>
                <select id="watchlistSelect" class="dropdown-large" disabled>
                    <option value="" disabled selected>Loading Watchlists...</option>
                </select>
            </div>
            <div class="sort-group">
                <label for="sortSelect">Sort By:</label>
                <select id="sortSelect" class="dropdown-large">
                    <option value="" disabled selected>Sort</option>
                    <option value="shareName-asc">ASX Code (A-Z)</option>
                    <option value="shareName-desc">ASX Code (Z-A)</option>
                    <option value="lastFetchedPrice-asc">Price (Low to High)</option>
                    <option value="lastFetchedPrice-desc">Price (High to Low)</option>
                    <option value="dividendAmount-asc">Dividend (Low to High)</option>
                    <option value="dividendAmount-desc">Dividend (High to Low)</option>
                    <option value="frankedYield-asc">Franked Yield (Low to High)</option>
                    <option value="frankedYield-desc">Franked Yield (High to Low)</option>
                    <option value="unfrankedYield-asc">Unfranked Yield (Low to High)</option>
                    <option value="unfrankedYield-desc">Unfranked Yield (High to Low)</option>
                    <option value="entryDate-asc">Entry Date (Oldest First)</option>
                    <option value="entryDate-desc">Entry Date (Newest First)</option>
                </select>
            </div>
        </div>
        <div id="asxCodeButtonsContainer" class="asx-code-buttons-container" style="display: none;">
            <!-- ASX Code Buttons will be dynamically loaded here -->
        </div>
    </header>

    <!-- Sidebar Menu (for both mobile and desktop) -->
    <nav id="appSidebar" class="app-sidebar">
        <button id="closeMenuBtn" class="close-menu-btn" aria-label="Close menu">&times;</button>
        <div class="menu-buttons-group">
            <h3>Shares</h3>
            <button id="newShareBtn" class="menu-button-item" data-action-closes-menu="true">
                <i class="fas fa-plus-circle"></i> Add New Share
            </button>
            <button id="viewDetailsBtn" class="menu-button-item" disabled data-action-closes-menu="true">
                <i class="fas fa-info-circle"></i> View Details
            </button>
        </div>
        <div class="menu-buttons-group">
            <h3>Calculators</h3>
            <button id="standardCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                <i class="fas fa-calculator"></i> Standard Calculator
            </button>
            <button id="dividendCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                <i class="fas fa-calculator"></i> Dividend Calculator
            </button>
        </div>
        <div class="menu-buttons-group">
            <h3>Settings</h3>
            <button id="themeToggleBtn" class="menu-button-item">
                <i class="fas fa-moon"></i> Toggle Theme
            </button>
        </div>
        <!-- User Info and Google Sign-in/Sign-out Button (at the bottom of the sidebar) -->
        <div class="user-auth-section" style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <button id="googleAuthBtn" class="menu-button-item" style="background-color: var(--google-auth-btn-bg);">
                <i class="fab fa-google"></i> Sign In
            </button>
        </div>
    </nav>
    <div class="sidebar-overlay"></div> <!-- Overlay for when sidebar is open on mobile -->

    <main class="container">
        <section class="share-list-section">
            <div id="loadingIndicator" class="loading">Loading shares...</div>
            <div class="table-container">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>ASX Code</th>
                            <th>Current Price</th>
                            <th>Target Price</th>
                            <th>Dividends/Yield</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be dynamically inserted here -->
            </div>
        </section>
    </main>

    <!-- Add/Edit Share Modal -->
    <div id="shareFormSection" class="modal">
        <div class="modal-content add-share-modal-content">
            <span class="close-button form-close-button">&times;</span>
            <h2 id="formTitle">Add New Share</h2>
            <form id="shareForm">
                <label for="shareName">ASX Code:</label>
                <input type="text" id="shareName" required placeholder="e.g., CBA">

                <label for="currentPrice">Current Price ($):</label>
                <input type="number" id="currentPrice" step="0.01" placeholder="e.g., 100.50">

                <label for="targetPrice">Target Price ($):</label>
                <input type="number" id="targetPrice" step="0.01" placeholder="e.g., 110.00">

                <label for="dividendAmount">Annual Dividend Amount ($/share):</label>
                <input type="number" id="dividendAmount" step="0.001" placeholder="e.g., 4.000">

                <label for="frankingCredits">Franking Credits (%):</label>
                <input type="number" id="frankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 100 (for fully franked)">

                <div class="comments-form-container" id="commentsFormContainer">
                    <h3>Comments <button type="button" id="addCommentSectionBtn" class="add-section-btn">+</button></h3>
                    <!-- Dynamic comment sections will be added here by JS -->
                </div>

                <div class="form-action-buttons">
                    <button type="button" id="saveShareBtn">
                        <i class="fas fa-save"></i> Save Share
                    </button>
                    <button type="button" id="cancelFormBtn">
                        <i class="fas fa-times-circle"></i> Cancel
                    </button>
                    <button type="button" id="deleteShareFromFormBtn" style="display: none;">
                        <i class="fas fa-trash-alt"></i> Delete Share
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Share Details Modal -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName">Share Name</h2>
            <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
            <p><strong>Current Price:</strong> <span id="modalCurrentPriceDetailed"></span></p>
            <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
            <p><strong>Annual Dividend:</strong> <span id="modalDividendAmount"></span></p>
            <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
            <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
            <p><strong>Franked Yield (Grossed-Up):</strong> <span id="modalFrankedYield"></span></p>

            <div id="modalCommentsContainer">
                <h3>Comments</h3>
                <!-- Comments will be loaded here -->
            </div>

            <div class="modal-action-buttons">
                <button type="button" id="editShareFromDetailBtn">
                    <i class="fas fa-edit"></i> Edit Share
                </button>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <span class="close-button calc-close-button">&times;</span>
            <h2>Dividend Calculator</h2>
            <div class="calc-input-group">
                <label for="calcDividendAmount">Annual Dividend Amount ($/share):</label>
                <input type="number" id="calcDividendAmount" step="0.001" placeholder="e.g., 4.000">
            </div>
            <div class="calc-input-group">
                <label for="calcCurrentPrice">Current Share Price ($):</label>
                <input type="number" id="calcCurrentPrice" step="0.01" placeholder="e.g., 100.50">
            </div>
            <div class="calc-input-group">
                <label for="calcFrankingCredits">Franking Credits (%):</label>
                <input type="number" id="calcFrankingCredits" step="0.1" min="0" max="100" value="100" placeholder="e.g., 100">
            </div>

            <hr>

            <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">-</span></p>
            <p><strong>Franked Yield (Grossed-Up):</strong> <span id="calcFrankedYield">-</span></p>

            <hr>

            <div class="calc-input-group">
                <label for="investmentValueSelect">Investment Value:</label>
                <select id="investmentValueSelect">
                    <option value="1000">AUD 1,000</option>
                    <option value="5000">AUD 5,000</option>
                    <option value="10000" selected>AUD 10,000</option>
                    <option value="20000">AUD 20,000</option>
                    <option value="50000">AUD 50,000</option>
                    <option value="100000">AUD 100,000</option>
                </select>
            </div>
            <p><strong>Estimated Annual Dividend Income:</strong> <span id="calcEstimatedDividend">-</span></p>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Standard Calculator</h2>
            <div class="calculator-display">
                <div id="calculatorInput" class="calculator-input"></div>
                <div id="calculatorResult" class="calculator-result">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">AC</button>
                <button class="calc-btn operator" data-action="percentage">%</button>
                <button class="calc-btn operator" data-action="divide">√∑</button>
                <button class="calc-btn" data-value="7">7</button>
                <button class="calc-btn" data-value="8">8</button>
                <button class="calc-btn" data-value="9">9</button>
                <button class="calc-btn operator" data-action="multiply">√ó</button>
                <button class="calc-btn" data-value="4">4</button>
                <button class="calc-btn" data-value="5">5</button>
                <button class="calc-btn" data-value="6">6</button>
                <button class="calc-btn operator" data-action="subtract">-</button>
                <button class="calc-btn" data-value="1">1</button>
                <button class="calc-btn" data-value="2">2</button>
                <button class="calc-btn" data-value="3">3</button>
                <button class="calc-btn operator" data-action="add">+</button>
                <button class="calc-btn zero" data-value="0">0</button>
                <button class="calc-btn" data-value=".">.</button>
                <button class="calc-btn equals" data-action="calculate">=</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal (for alerts/confirms) -->
    <div id="customDialogModal" class="modal">
        <div class="modal-content">
            <p id="customDialogMessage"></p>
            <div class="custom-dialog-buttons">
                <button id="customDialogConfirmBtn">Yes</button>
                <button id="customDialogCancelBtn">No</button>
            </div>
        </div>
    </div>
    
    <!-- Scroll to Top Button -->
    <button id="scrollToTopBtn" aria-label="Scroll to top">
        <i class="fas fa-arrow-up"></i>
    </button>

    <footer class="fixed-footer">
        <p>&copy; 2025 Kangas ASX Share Watchlist</p>
    </footer>

    <!-- Firebase SDK (ensure these are correctly loaded for window.firebaseAuth etc to be available) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, FieldValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Configuration and App ID
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let app;
        let db;
        let auth;
        let firebaseInitialized = false;

        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                firebaseInitialized = true;
                console.log("Firebase: Initialized successfully with config.");
            } else {
                console.warn("Firebase: Configuration is empty. Firebase services will not be available.");
            }
        } catch (error) {
            console.error("Firebase: Error initializing Firebase:", error);
            document.getElementById('loadingIndicator').textContent = "Error initializing Firebase. Please check console.";
        }

        // Expose Firebase instances globally for script.js
        window.firestoreDb = db;
        window.firebaseAuth = auth;
        window.getFirebaseAppId = () => currentAppId; // Getter function for app ID

        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete // Expose deleteField for migrations
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken, // Still included for compatibility, but might not be directly used for initial auth flow on GH Pages
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;

        // Authenticate when the DOM is fully loaded for the module script itself
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html (v29) script module loaded and DOMContentLoaded fired.");
            // We removed the custom event dispatch here, script.js will pick up firebaseAuth directly.
        }); 
    </script>
    <script src="script.js"></script>
</body>
</html>
